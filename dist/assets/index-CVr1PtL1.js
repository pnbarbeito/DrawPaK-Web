const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-4Rux7z0p.js","assets/vendor-B5DZHykP.css"])))=>i.map(i=>d[i]);
import{D as gn,r as N,j as e,B as v,T as G,a as lo,I as Ie,A as hn,b as fn,c as pn,u as Cr,R as w,d as co,P as B,H as mn,e as yn,f as J,g as de,h as Qr,F as Kt,C as Vt,S as br,i as dt,k as ut,l as gt,m as vr,n as Sr,o as kr,M as Le,p as ht,q as wn,s as xn,t as bn,v as vn,_ as Mt,w as Sn,x as kn,y as jn,z as Cn,E as _n,G as An,J as En,K as Nn,L as In,N as lt,O as ct,Q as Dn,U as eo,V as to,W as zn,X as Mn,Y as Tn,Z as Ln}from"./vendor-4Rux7z0p.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const x of document.querySelectorAll('link[rel="modulepreload"]'))d(x);new MutationObserver(x=>{for(const c of x)if(c.type==="childList")for(const l of c.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&d(l)}).observe(document,{childList:!0,subtree:!0});function a(x){const c={};return x.integrity&&(c.integrity=x.integrity),x.referrerPolicy&&(c.referrerPolicy=x.referrerPolicy),x.crossOrigin==="use-credentials"?c.credentials="include":x.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function d(x){if(x.ep)return;x.ep=!0;const c=a(x);fetch(x.href,c)}})();class Pn extends gn{schemas;svg_elements;constructor(){super("drawpak"),this.version(1).stores({schemas:"++id,name,updated_at,local",svg_elements:"++id,name,category,updated_at,local"}),this.version(2).stores({schemas:"id,name,updated_at,local,synchronized,hidden",svg_elements:"id,name,category,updated_at,local,synchronized,hidden"}).upgrade(async o=>{try{const a=o.table("schemas"),d=o.table("svg_elements"),x=await a.toArray();for(const l of x)if(!l.id||typeof l.id=="number"){const y=typeof crypto<"u"?crypto.randomUUID:void 0,p=typeof y=="function"?y():"id-"+Date.now()+"-"+Math.random().toString(36).slice(2);l.id=p,await a.put(l)}const c=await d.toArray();for(const l of c){if(!l.id||typeof l.id=="number"){const y=typeof crypto<"u"?crypto.randomUUID:void 0,p=typeof y=="function"?y():"id-"+Date.now()+"-"+Math.random().toString(36).slice(2);l.id=p}typeof l.synchronized!="boolean"&&(l.synchronized=!1),typeof l.hidden!="boolean"&&(l.hidden=!1),await d.put(l)}for(const l of x){const y=l;let p=!1;typeof y.synchronized!="boolean"&&(y.synchronized=!1,p=!0),typeof y.hidden!="boolean"&&(y.hidden=!1,p=!0),p&&await a.put(y)}}catch(a){console.warn("Dexie upgrade migration to UUID ids failed:",a)}}),this.schemas=this.table("schemas"),this.svg_elements=this.table("svg_elements")}}const O=new Pn,mr={};async function uo(i){const o=i||$e();if(!o)return null;const a=mr[o];if(a)return a;const d=(async()=>{try{const x=typeof window<"u"?new URL(`/api/user-library/${encodeURIComponent(o)}`,window.location.origin).toString():`/api/user-library/${encodeURIComponent(o)}`,c=await fetch(x);if(c.status===404||!c.ok)return null;const l=await c.json();return{data:l.data||{elements:[]},updated_at:l.updated_at||l.updatedAt}}catch(x){return console.warn("fetchUserLibraryOnce failed",x),null}})();return mr[o]=d,d.finally(()=>{try{delete mr[o]}catch{}}),d}let St=null;function ye(){return new Date().toISOString()}function jt(i){if(i!=null){if(typeof i=="boolean")return i;if(typeof i=="number")return i===1;if(typeof i=="string"){const o=i.trim().toLowerCase();return o==="1"||o==="true"?!0:o==="0"||o==="false"?!1:void 0}}}const Rn="drawpak:user_library_updated_at";function $e(){try{return localStorage.getItem("dp_username")||localStorage.getItem("username")||null}catch{return null}}function go(i){const o=i||$e()||"anon";return`${Rn}:${o}`}function ho(i){try{return localStorage.getItem(go(i))}catch{return null}}function kt(i,o){try{const a=go(i),d=o||ye();localStorage.setItem(a,d)}catch{}}const On="drawpak:user_schemas_updated_at";function fo(i){const o=i||$e()||"anon";return`${On}:${o}`}function Wn(i){try{return localStorage.getItem(fo(i))}catch{return null}}function Pt(i,o){try{const a=fo(i),d=o||ye();localStorage.setItem(a,d)}catch{}}async function ro(i){return await _r(i)}function $n(i,o){const a={};a.version=o&&o.version?o.version:i&&i.version?i.version:1;const d=Array.isArray(i?.elements)?i.elements:[],x=Array.isArray(o?.elements)?o.elements:[];if(d.length===0&&x.length>0)a.elements=x;else if(x.length===0&&d.length>0)a.elements=d;else{const p=new Map;for(const S of d)S&&typeof S=="object"&&"id"in S&&p.set(String(S.id),S);for(const S of x)if(S&&typeof S=="object"&&"id"in S){const M=String(S.id),_=p.get(M)||{};p.set(M,{..._,...S})}a.elements=Array.from(p.values())}const c=Array.isArray(i?.schemas)?i.schemas:[],l=Array.isArray(o?.schemas)?o.schemas:[];if(c.length===0&&l.length>0)a.schemas=l;else if(l.length===0&&c.length>0)a.schemas=c;else{const p=new Map;for(const S of c)S&&typeof S=="object"&&"id"in S&&p.set(String(S.id),S);for(const S of l)if(S&&typeof S=="object"&&"id"in S){const M=String(S.id),_=p.get(M)||{};p.set(M,{..._,...S})}a.schemas=Array.from(p.values())}const y=new Set([...Object.keys(i||{}),...Object.keys(o||{})]);for(const p of y){if(p==="elements"||p==="schemas"||p==="version")continue;const S=o,M=i;S&&S[p]!==void 0?a[p]=S[p]:M&&M[p]!==void 0?a[p]=M[p]:a[p]=void 0}return a}async function _r(i){const o=i||$e();if(!o)return!1;await ze();const a=await bo(),d=await xo(),x=a.map(wo),c=d.map(yo),l={username:o,updated_at:ho(o)||ye(),data:{version:1,elements:x,schemas:c}};try{const y=await po(o).catch(()=>null),p=y&&y.data?y.data:{version:1,elements:[]},S=$n(p,l.data),M={username:o,updated_at:l.updated_at,data:S},_=typeof window<"u"?new URL(`/api/user-library/${encodeURIComponent(o)}`,window.location.origin).toString():`/api/user-library/${encodeURIComponent(o)}`,U=await fetch(_,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(M)});if(!U.ok)return console.warn("uploadFullUserLibrary failed:",await U.text().catch(()=>"<no-body>")),!1;const T=await U.json().catch(()=>null);T&&T.updated_at?(kt(o,String(T.updated_at)),Pt(o,String(T.updated_at))):(kt(o),Pt(o));try{await O.transaction("rw",O.svg_elements,O.schemas,async()=>{await O.svg_elements.toCollection().modify(K=>{K.synchronized=!0}),await O.schemas.toCollection().modify(K=>{K.synchronized=!0})})}catch(K){console.warn("Failed to mark local rows as synchronized after upload:",K)}return!0}catch(y){return console.warn("uploadFullUserLibrary network error",y),!1}}const Yt={},Fn=2e3;function Zt(i){const o=i||$e();if(o){try{Yt[o]&&clearTimeout(Yt[o])}catch{}Yt[o]=setTimeout(async()=>{try{if(await _r(o))try{kt(o)}catch{}}catch(a){console.warn("Debounced uploadFullUserLibrary failed",a)}finally{try{delete Yt[o]}catch{}}},Fn)}}async function po(i){const o=i||$e();if(!o)return null;try{return await uo(o)}catch(a){return console.warn("downloadUserLibrary failed",a),null}}async function Bn(i,o,a){await ze();try{await O.transaction("rw",O.svg_elements,async()=>{await O.svg_elements.clear();for(const d of i){const x={id:d.id,name:d.name||"",description:d.description||"",category:d.category||"custom",svg:d.svg||"",handles:d.handles||"",created_at:d.created_at||ye(),created_by:d.created_by||a||void 0,updated_at:d.updated_at||d.created_at||ye(),updated_by:d.updated_by||d.created_by||a||void 0,local:typeof d.local=="boolean"?d.local:!1,synchronized:!0,hidden:jt(d.hidden)??!1};await O.svg_elements.put(x)}}),kt(a,o||ye())}catch(d){console.error("replaceLocalLibraryWith failed",d)}}async function oo(i){const o=i||$e();if(!o)return;await ze();const a=ho(o),d=await po(o);if(!d){a&&await ro(o);return}const x=d.updated_at||null,c=a?Date.parse(a):0,l=x?Date.parse(x):0;if(!(a&&x&&c===l)){if(a&&c>l){await ro(o);return}try{const y=d.data;if(!y)return;const p=Array.isArray(y.elements)?y.elements:Array.isArray(y)?y:[];await Bn(p,x||void 0,o)}catch(y){console.warn("reconcileUserLibrary failed to apply server library",y)}}}async function no(i){return await _r(i)}async function Un(i){const o=i||$e();if(!o)return null;try{const a=await uo(o);return a?{data:a.data||{schemas:[]},updated_at:a.updated_at}:null}catch(a){return console.warn("downloadUserSchemas failed",a),null}}async function qn(i,o,a){await ze();try{await O.transaction("rw",O.schemas,async()=>{await O.schemas.clear();for(const d of i){const x={id:d.id,name:d.name||"",description:d.description||"",nodes:d.nodes||"[]",edges:d.edges||"[]",created_at:d.created_at||ye(),created_by:d.created_by||a||void 0,updated_at:d.updated_at||d.created_at||ye(),updated_by:d.updated_by||d.created_by||a||void 0,local:typeof d.local=="boolean"?d.local:!1,synchronized:!0,hidden:jt(d.hidden)??!1};await O.schemas.put(x)}}),Pt(a,o||ye())}catch(d){console.error("replaceLocalSchemasWith failed",d)}}async function yr(i){const o=i||$e();if(!o)return;await ze();const a=Wn(o),d=await Un(o);if(!d){a&&await no(o);return}const x=d.updated_at||null,c=a?Date.parse(a):0,l=x?Date.parse(x):0;if(!(a&&x&&c===l)){if(a&&c>l){await no(o);return}try{const y=d.data;if(!y)return;const p=Array.isArray(y.schemas)?y.schemas:Array.isArray(y)?y:[];await qn(p,x||void 0,o)}catch(y){console.warn("reconcileUserSchemas failed to apply server schemas",y)}}}async function ze(){return await O.open(),await Vn(),!0}async function mo(i){await ze();const o=ye(),a={...i,created_at:i.created_at||o,created_by:i.created_by||void 0,updated_by:i.updated_by||i.created_by||void 0,updated_at:o,local:typeof i.local=="boolean"?i.local:!1};if(!a.id||typeof a.id!="string")try{a.id=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(36).slice(2,10)}`}catch{a.id=`id-${Date.now()}-${Math.random().toString(36).slice(2,10)}`}await O.schemas.put(a);try{Pt()}catch{}Ar().catch(()=>{});try{const d=$e();if(d)try{Zt(d)}catch{}}catch{}return a.id}function yo(i){const o=i,a=o.created_by!==void 0?String(o.created_by):void 0,d=o.updated_by!==void 0?String(o.updated_by):void 0;return{id:i.id,name:i.name||"",description:i.description||"",nodes:i.nodes||"[]",edges:i.edges||"[]",created_at:i.created_at||ye(),updated_at:i.updated_at||ye(),created_by:a,updated_by:d,local:0,hidden:jt(i.hidden)??!1}}function wo(i){const o=i,a=o.created_by!==void 0?String(o.created_by):void 0,d=o.updated_by!==void 0?String(o.updated_by):void 0;return{id:i.id,name:i.name||"",description:i.description||"",category:i.category||"custom",svg:i.svg||"",handles:i.handles||"",created_at:i.created_at||ye(),updated_at:i.updated_at||ye(),created_by:a,updated_by:d,local:0,hidden:jt(i.hidden)??!1}}async function wr(i,o){await ze();const a=await O.schemas.get(i);if(!a)throw new Error("Esquema no encontrado");const d={...a,...o,updated_at:ye(),updated_by:o.updated_by||a.updated_by||a.created_by,local:typeof o.local=="boolean"?o.local:a.local};await O.schemas.put(d);try{Pt()}catch{}Ar().catch(()=>{});try{const x=$e();if(x)try{Zt(x)}catch{}}catch{}}async function xo(){return await ze(),(await O.schemas.toArray()).sort((o,a)=>(a.updated_at||"").localeCompare(o.updated_at||""))}async function Hn(i){return await ze(),await O.schemas.get(i)||null}async function Ar(){await ze();const i=typeof localStorage<"u"?localStorage.getItem("username"):null;try{await O.transaction("rw",O.schemas,async()=>{await O.schemas.toCollection().modify(c=>{c.synchronized=!1})})}catch(c){console.warn("Failed to reset synchronized flags for schemas before sync:",c)}let o=[];try{const c=typeof window<"u"?new URL("/api/schemas",window.location.origin).toString():"/api/schemas";let l=null;try{l=await fetch(c)}catch(y){console.warn("Initial fetch(/api/schemas) failed, retrying in 2s...",y),await new Promise(p=>setTimeout(p,2e3));try{l=await fetch(c)}catch(p){console.warn("Retry fetch(/api/schemas) failed; aborting schemas sync for now",p);return}}if(!l||!l.ok){console.warn("fetch(/api/schemas) returned non-ok status:",l&&l.status);const y=await l?.json().catch(()=>null);o=Array.isArray(y)?y:[]}else{const y=await l.json();o=Array.isArray(y)?y:[]}}catch(c){console.warn("Unexpected error during fetch(/api/schemas):",c);return}const a=new Map;for(const c of o)c&&c.id&&a.set(String(c.id),c);const d=await O.schemas.toArray(),x=new Map;for(const c of d)c&&c.id&&x.set(String(c.id),c);try{await O.transaction("rw",O.schemas,async()=>{for(const[c,l]of a.entries()){const y=x.get(c),p={id:String(l.id),name:l.name?String(l.name):"",description:l.description?String(l.description):"",nodes:l.nodes?String(l.nodes):"[]",edges:l.edges?String(l.edges):"[]",created_at:l.created_at?String(l.created_at):ye(),created_by:l.created_by?String(l.created_by):void 0,updated_at:l.updated_at?String(l.updated_at):ye(),updated_by:l.updated_by?String(l.updated_by):void 0,local:!!l.local};if(!y)p.synchronized=!0,await O.schemas.put(p);else{const S=Date.parse(String(l.updated_at||l.created_at||""))||0,M=Date.parse(String(y.updated_at||y.created_at||""))||0;S>M&&(p.synchronized=!0,await O.schemas.put(p))}}})}catch(c){console.warn("Error applying server->local schemas sync:",c)}for(const c of d)try{if(!c.id||a.has(c.id))continue;if(c.local===!1){const l=yo(c);c.created_by?l.username=c.created_by:i&&(l.username=i);try{const y=await fetch("/api/schemas",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!y.ok)console.warn("Failed to push local schema to server",c.id,await y.text());else try{await O.schemas.update(c.id,{synchronized:!0})}catch{}}catch(y){console.warn("Network error pushing local schema to server",c.id,y)}}}catch(l){console.warn("Error handling local schema for push:",l)}}async function Yn(i,o){const a=await Hn(i);if(!a)throw new Error("Esquema no encontrado");const d={name:o,description:a.description,nodes:a.nodes,edges:a.edges,created_at:ye(),created_by:a.created_by||void 0,updated_by:a.updated_by||a.created_by||void 0,updated_at:ye(),local:a.local!==void 0?a.local:!1};return await mo(d)}async function Xn(i){await ze();const o=ye(),a={...i,created_at:i.created_at||o,created_by:i.created_by||void 0,updated_by:i.updated_by||i.created_by||void 0,updated_at:o,local:typeof i.local=="boolean"?i.local:!1,synchronized:typeof i.synchronized=="boolean"?i.synchronized:!1,hidden:jt(i.hidden)??!1};if(!a.id||typeof a.id!="string")try{a.id=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(36).slice(2,10)}`}catch{a.id=`id-${Date.now()}-${Math.random().toString(36).slice(2,10)}`}await O.svg_elements.put(a);try{kt()}catch{}await Qt();try{const d=$e();if(d)try{Zt(d)}catch{}}catch{}return a.id}async function so(i,o){await ze();const a=await O.svg_elements.get(i);if(!a)throw new Error("SVG element not found");const d={...a,...o,updated_at:ye(),updated_by:o.updated_by||a.updated_by||a.created_by,local:typeof o.local=="boolean"?o.local:a.local,synchronized:typeof o.synchronized=="boolean"?o.synchronized:a.synchronized},x=jt(o.hidden)??a.hidden===!0;d.hidden=x,await O.svg_elements.put(d);try{kt()}catch{}try{const c=$e();if(c)try{Zt(c)}catch{}}catch{}}async function bo(){return await ze(),(await O.svg_elements.toArray()).sort((o,a)=>(a.updated_at||"").localeCompare(o.updated_at||""))}async function Jn(i){return await ze(),(await O.svg_elements.where("category").equals(i).toArray()).sort((a,d)=>(a.name||"").localeCompare(d.name||""))}async function jr(){await ze();const i=await O.svg_elements.toArray(),o=new Set;return i.forEach(a=>{a.category&&o.add(a.category)}),Array.from(o).sort()}async function Gn(){await ze(),await O.svg_elements.clear()}async function Kn(){try{try{O.close()}catch{}await new Promise(i=>{try{const o=indexedDB.deleteDatabase("drawpak");o.onsuccess=()=>i(),o.onblocked=()=>i(),o.onerror=()=>i()}catch{i()}})}catch{}}async function Qt(){await ze();const i=typeof localStorage<"u"?localStorage.getItem("username"):null;try{await O.transaction("rw",O.svg_elements,async()=>{await O.svg_elements.toCollection().modify(c=>{c.synchronized=!1})})}catch(c){console.warn("Failed to reset synchronized flags before sync:",c)}let o=[];try{const c=await fetch("/api/svgs");if(!c.ok)return;const l=await c.json();o=Array.isArray(l)?l:[]}catch{return}const a=new Map;for(const c of o)c&&c.id&&a.set(String(c.id),c);const d=await O.svg_elements.toArray(),x=new Map;for(const c of d)c&&c.id&&x.set(String(c.id),c);try{await O.transaction("rw",O.svg_elements,async()=>{for(const[c,l]of a.entries()){const y=x.get(c),p={id:String(l.id),name:l.name?String(l.name):"",description:l.description?String(l.description):"",category:l.category?String(l.category):"basic",svg:l.svg?String(l.svg):"",handles:l.handles?String(l.handles):"",created_at:l.created_at?String(l.created_at):void 0,created_by:l.created_by?String(l.created_by):void 0,updated_at:l.updated_at?String(l.updated_at):l.created_at?String(l.created_at):void 0,updated_by:l.updated_by?String(l.updated_by):void 0,local:!!l.local,synchronized:!0,hidden:y&&typeof y.hidden=="boolean"?y.hidden:!1};if(!y)await O.svg_elements.put(p);else{const S=Date.parse(String(l.updated_at||l.created_at||""))||0,M=Date.parse(String(y.updated_at||y.created_at||""))||0;if(S>M)await O.svg_elements.put(p);else try{await O.svg_elements.update(String(y.id),{synchronized:!0,hidden:typeof y.hidden=="boolean"?y.hidden:!1})}catch(_){console.warn("Failed to mark existing local svg as synchronized:",y.id,_)}}}})}catch(c){console.warn("Error applying server->local sync:",c)}for(const c of d)try{if(!c.id||a.has(c.id))continue;if(c.local===!1){const l=wo(c);c.created_by&&(l.created_by=c.created_by),c.updated_by&&(l.updated_by=c.updated_by),i&&(l.username=i);try{const y=await fetch("/api/svgs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!y.ok)console.warn("Failed to push local svg to server",c.id,await y.text());else try{await O.svg_elements.update(c.id,{synchronized:!0})}catch(p){console.warn("Failed to mark local svg as synchronized after push:",c.id,p)}}catch(y){console.warn("Network error pushing local svg to server",c.id,y)}}}catch(l){console.warn("Error handling local svg for push:",l)}try{typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new Event("svg-elements-updated"))}catch{}}async function Vn(){return St||(St=(async()=>{if(await O.svg_elements.count()>0)return;try{const l=await fetch("/api/svgs");if(l.ok){const y=await l.json();if(Array.isArray(y)&&y.length>0)try{await O.transaction("rw",O.svg_elements,async()=>{for(const p of y){const S={id:p.id,name:p.name||"",description:p.description||"",category:p.category||"basic",svg:p.svg||"",handles:p.handles||"",created_at:p.created_at||ye(),created_by:p.created_by||"server",updated_at:p.updated_at||ye(),updated_by:p.updated_by||p.created_by||"server",local:!!p.local};S.id?await O.svg_elements.put(S):await O.svg_elements.where("name").equalsIgnoreCase(S.name).and(_=>(_.category||"basic")===(S.category||"basic")).first()||await O.svg_elements.add(S)}}),St=null;return}catch(p){console.warn("Fallo al aplicar seeds desde backend, proceder con locales:",p)}}}catch{}const o=[{id:"fa31ce0c-fb55-4685-bcc9-3bfb0d5bdee5",name:"Transformador",description:"Transformador básico",category:"transformadores",created_at:"2025-09-09T14:19:32+00:00",svg:`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120" style="background: rgba(255, 255, 255, 0);">
        <defs xmlns="http://www.w3.org/2000/svg"/>
        <g xmlns="http://www.w3.org/2000/svg">
            <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 60, 40)">
                <circle xmlns="http://www.w3.org/2000/svg" cx="60" fill-opacity="0" fill="#fff" stroke="#000" r="25" stroke-width="2" cy="40"/>
            </g>
        </g>
        <g xmlns="http://www.w3.org/2000/svg">
            <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 60, 80)">
                <circle xmlns="http://www.w3.org/2000/svg" cx="60" fill-opacity="0" fill="#fff" stroke="#000" r="25" stroke-width="2" cy="80"/>
            </g>
        </g>
        <g xmlns="http://www.w3.org/2000/svg">
            <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 60, 7.5)">
                <line xmlns="http://www.w3.org/2000/svg" y2="15" y1="0" stroke="#000" x2="60" stroke-width="2" x1="60"/>
            </g>
        </g>
        <g xmlns="http://www.w3.org/2000/svg">
            <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 60, 112.5)">
                <line xmlns="http://www.w3.org/2000/svg" y2="105" y1="120" stroke="#000" x2="60" stroke-width="2" x1="60"/>
                <g xmlns="http://www.w3.org/2000/svg"/>
            </g>
        </g>
    </svg>`,handles:JSON.stringify([{id:"top",x:60,y:0,type:"source"},{id:"bottom",x:60,y:120,type:"target"}])},{id:"51399c85-3dc0-452c-b2eb-5436202eb63f",name:"Transformador Doble",description:"Transformador con doble salida",category:"transformadores",created_at:"2025-09-09T14:19:32+00:00",svg:`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 160" style="background: rgba(255, 255, 255, 0);">
          <defs xmlns="http://www.w3.org/2000/svg"/>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 60, 60)">
                  <circle xmlns="http://www.w3.org/2000/svg" fill-opacity="0" cx="60" fill="#fff" stroke-width="2" stroke="#000" cy="60" r="30"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 40, 100)">
                  <circle xmlns="http://www.w3.org/2000/svg" fill-opacity="0" cx="40" fill="#fff" stroke-width="2" stroke="#000" cy="100" r="30"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 80, 100)">
                  <circle xmlns="http://www.w3.org/2000/svg" fill-opacity="0" cx="80" fill="none" stroke-width="2" stroke="#000" cy="100" r="30"/>
                  <g xmlns="http://www.w3.org/2000/svg"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 60, 15)">
                  <line xmlns="http://www.w3.org/2000/svg" x1="60" y1="30" stroke-width="2" stroke="#000" y2="0" x2="60"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 40, 145)">
                  <line xmlns="http://www.w3.org/2000/svg" x1="40" y1="160" stroke-width="2" stroke="#000" y2="130" x2="40"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 80, 145)">
                  <line xmlns="http://www.w3.org/2000/svg" x1="80" y1="160" stroke-width="2" stroke="#000" y2="130" x2="80"/>
              </g>
          </g>
      </svg>`,handles:JSON.stringify([{id:"top",x:60,y:0,type:"source"},{id:"left",x:40,y:160,type:"target"},{id:"right",x:80,y:160,type:"target"}])}],a=[{id:"c179addb-150c-475a-8ae3-543a187e9728",name:"Interruptor",description:"Interruptor",category:"proteccion",created_at:"2025-09-09T14:19:32+00:00",svg:`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 80" style="background: rgba(255, 255, 255, 0);">
          <defs xmlns="http://www.w3.org/2000/svg"/>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 30, 40)">
                  <circle xmlns="http://www.w3.org/2000/svg" stroke="#000" stroke-width="1" r="4" fill="#000" cx="30" cy="40"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 90, 40)">
                  <circle xmlns="http://www.w3.org/2000/svg" stroke="#000" stroke-width="1" r="4" fill="#000" cx="90" cy="40"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 15, 40)">
                  <line xmlns="http://www.w3.org/2000/svg" y1="40" stroke="#000" y2="40" stroke-width="2" x1="0" x2="30"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 60, 30)">
                  <line xmlns="http://www.w3.org/2000/svg" y1="40" stroke="#000" y2="20" stroke-width="2" x1="30" x2="90"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 105, 40)">
                  <line xmlns="http://www.w3.org/2000/svg" y1="40" stroke="#000" y2="40" stroke-width="2" x1="90" x2="120"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 60, 35)">
                  <rect xmlns="http://www.w3.org/2000/svg" x="20" y="10" stroke="#000" stroke-width="2" fill="rgba(255, 255, 255, 0)" width="80" fill-opacity="0" height="50"/>
                  <g xmlns="http://www.w3.org/2000/svg"/>
              </g>
          </g>
      </svg>`,handles:JSON.stringify([{id:"left",type:"source",x:0,y:40},{id:"right",type:"target",x:120,y:40}])},{id:"442c7305-e553-4ead-90bf-8c639c6cc1df",name:"Interruptor Extraido",description:"Interruptor",category:"proteccion",created_at:"2025-09-09T14:19:32+00:00",svg:`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 120" style="background: rgba(255, 255, 255, 0);">
          <defs xmlns="http://www.w3.org/2000/svg"/>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 100, 46)">
                  <rect xmlns="http://www.w3.org/2000/svg" fill="rgba(255, 255, 255, 0)" fill-opacity="0" height="50" x="60" width="80" y="21" stroke="#000" stroke-width="2"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 70, 50)">
                  <circle xmlns="http://www.w3.org/2000/svg" fill="#000" stroke="#000" stroke-width="1" cy="50" cx="70" r="4"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 130, 50)">
                  <circle xmlns="http://www.w3.org/2000/svg" fill="#000" stroke="#000" stroke-width="1" cy="50" cx="130" r="4"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 15, 100)">
                  <line xmlns="http://www.w3.org/2000/svg" x1="0" stroke="#000" stroke-width="2" x2="30" y2="100" y1="100"/>
                  <g xmlns="http://www.w3.org/2000/svg"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 100, 40)">
                  <line xmlns="http://www.w3.org/2000/svg" x1="70" stroke="#000" stroke-width="2" x2="130" y2="30" y1="50"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 186, 100)">
                  <line xmlns="http://www.w3.org/2000/svg" x1="170" stroke="#000" stroke-width="2" x2="202" y2="100" y1="100"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 55, 50)">
                  <line xmlns="http://www.w3.org/2000/svg" x1="40" stroke="#000" stroke-width="2" x2="70" y2="50" y1="50"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 145, 50)">
                  <line xmlns="http://www.w3.org/2000/svg" x1="130" stroke="#000" stroke-width="2" x2="160" y2="50" y1="50"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(270, 50, 100)">
                  <path xmlns="http://www.w3.org/2000/svg" fill="none" stroke-linecap="butt" d="M 30 100 A 20 20 0 0 1 70 100" stroke="#000" stroke-width="2"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(90, 150, 100)">
                  <path xmlns="http://www.w3.org/2000/svg" fill="none" stroke-linecap="butt" d="M 130 100 A 20 20 0 0 1 170 100" stroke="#000" stroke-width="2"/>
              </g>
          </g>
      </svg>`,handles:JSON.stringify([{id:"left",type:"source",x:0,y:100},{id:"right",type:"target",x:200,y:100}])},{id:"eddb3c2a-c6ae-42d0-8d6d-3614c24b7139",name:"Seccionador",description:"Seccionador de línea",category:"proteccion",created_at:"2025-09-09T14:19:32+00:00",svg:`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 80" style="background: rgba(255, 255, 255, 0);">
          <defs xmlns="http://www.w3.org/2000/svg"/>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 30, 40)">
                  <circle xmlns="http://www.w3.org/2000/svg" stroke="#000" stroke-width="1" r="4" fill="#000" cx="30" cy="40"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 90, 40)">
                  <circle xmlns="http://www.w3.org/2000/svg" stroke="#000" stroke-width="1" r="4" fill="#000" cx="90" cy="40"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 15, 40)">
                  <line xmlns="http://www.w3.org/2000/svg" y1="40" stroke="#000" y2="40" stroke-width="2" x1="0" x2="30"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 60, 30)">
                  <line xmlns="http://www.w3.org/2000/svg" y1="40" stroke="#000" y2="20" stroke-width="2" x1="30" x2="90"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 105, 40)">
                  <line xmlns="http://www.w3.org/2000/svg" y1="40" stroke="#000" y2="40" stroke-width="2" x1="90" x2="120"/>
              </g>
          </g>
      </svg>`,handles:JSON.stringify([{id:"left",type:"source",x:0,y:40},{id:"right",type:"target",x:120,y:40}])}],d=[{id:"41dbe6ce-7cd5-4c23-a5ca-3ac50bf69cea",name:"Barra Simple",description:"Barras de conexión",category:"infraestructura",created_at:"2025-09-09T14:19:32+00:00",svg:`
      <svg xmlns="http://www.w3.org/2000/svg" style="background: rgba(255, 255, 255, 0);" viewBox="0 0 200 200">
          <defs xmlns="http://www.w3.org/2000/svg"/>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 39.5, 100)">
                  <rect xmlns="http://www.w3.org/2000/svg" x="37.5" height="200" fill="#000" stroke-width="1" y="0" width="4" stroke="#000"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 120, 100)">
                  <line xmlns="http://www.w3.org/2000/svg" y1="100" x2="200" stroke-width="2" x1="40" y2="100" stroke="#000"/>.
                  <g xmlns="http://www.w3.org/2000/svg"/>
              </g>
          </g>
      </svg>`,handles:JSON.stringify([{id:"h_1756826687664",type:"target",x:40,y:200},{id:"h_1756829757274",type:"source",x:40,y:0},{id:"h_1756829764787",type:"target",x:200,y:100}])},{id:"af6a241f-25b3-4926-9cde-360dc22d20ad",name:"Barra Doble",description:"Barras de conexión",category:"infraestructura",created_at:"2025-09-09T14:19:32+00:00",svg:`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" style="background: rgba(255, 255, 255, 0);">
          <defs xmlns="http://www.w3.org/2000/svg"/>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 39.5, 100)">
                  <rect xmlns="http://www.w3.org/2000/svg" x="37.5" y="0" width="4" height="200" fill="#000" stroke="#000" stroke-width="1"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 79.5, 100)">
                  <rect xmlns="http://www.w3.org/2000/svg" x="77.5" y="0" width="4" height="200" fill="#000" stroke="#000" stroke-width="1"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 120, 40)">
                  <line xmlns="http://www.w3.org/2000/svg" y2="40" y1="40" stroke="#000" x2="200" stroke-width="2" x1="40"/>
                  <g xmlns="http://www.w3.org/2000/svg"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 139, 160)">
                  <line xmlns="http://www.w3.org/2000/svg" y2="160" y1="160" stroke="#000" x2="200" stroke-width="2" x1="78"/>
              </g>
          </g>
      </svg>`,handles:JSON.stringify([{id:"h_1756826687664",type:"target",x:40,y:200},{id:"h_1756826687995",type:"source",x:40,y:0},{id:"h_1756826670572",type:"target",x:80,y:200},{id:"h_1756826671210",type:"source",x:80,y:0},{id:"r_top",type:"target",x:200,y:40},{id:"b_right",type:"target",x:200,y:160}])},{id:"ec8d9bea-25c8-44de-a4af-3035697e7457",name:"Barra Triple",description:"Barras de conexión",category:"infraestructura",created_at:"2025-09-09T14:19:32+00:00",svg:`
      <svg xmlns="http://www.w3.org/2000/svg" style="background: rgba(255, 255, 255, 0);" viewBox="0 0 200 200">
          <defs xmlns="http://www.w3.org/2000/svg"/>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 20.5, 100)">
                  <rect xmlns="http://www.w3.org/2000/svg" x="18.5" height="200" fill="#000" stroke-width="1" y="0" width="4" stroke="#000"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 60.5, 100)">
                  <rect xmlns="http://www.w3.org/2000/svg" x="58.5" height="200" fill="#000" stroke-width="1" y="0" width="4" stroke="#000"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 100, 100)">
                  <rect xmlns="http://www.w3.org/2000/svg" x="98" height="200" fill="#000" stroke-width="1" y="0" width="4" stroke="#000"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 150, 160)">
                  <line xmlns="http://www.w3.org/2000/svg" y1="160" x2="200" stroke-width="2" x1="100" y2="160" stroke="#000"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 110, 40)">
                  <line xmlns="http://www.w3.org/2000/svg" y1="40" x2="200" stroke-width="2" x1="20" y2="40" stroke="#000"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 130, 100)">
                  <line xmlns="http://www.w3.org/2000/svg" y1="100" x2="200" stroke-width="2" x1="60" y2="100" stroke="#000"/>
                  <g xmlns="http://www.w3.org/2000/svg"/>
              </g>
          </g>
      </svg>`,handles:JSON.stringify([{id:"h_1756826687664",type:"target",x:20,y:200},{id:"h_1756830053495",type:"source",x:20,y:0},{id:"h_1756830129231",type:"target",x:60,y:200},{id:"h_1756826687995",type:"source",x:60,y:0},{id:"h_1756826671210",type:"source",x:100,y:0},{id:"r_top",type:"target",x:200,y:40},{id:"h_1756826670572",type:"target",x:100,y:200},{id:"b_right",type:"target",x:200,y:160},{id:"h_1756830118484",type:"target",x:200,y:100}])}],x=[{id:"67de6f6d-0f4e-4c46-abe6-6dc6fb5a885d",name:"Candado",description:"Dispositivo de bloqueo",category:"seguridad",created_at:"2025-09-09T14:19:32+00:00",svg:`
      <svg xmlns="http://www.w3.org/2000/svg" style="background: rgba(255, 255, 255, 0);" viewBox="0 0 60 60">
          <defs xmlns="http://www.w3.org/2000/svg"/>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 30, 43.5)">
                  <rect xmlns="http://www.w3.org/2000/svg" stroke-width="2" fill="#62a0ea" width="40" stroke="#000" y="31" height="25" x="10"/>
                  <g xmlns="http://www.w3.org/2000/svg"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 16, 24.5)">
                  <line xmlns="http://www.w3.org/2000/svg" stroke-width="2" y1="32" x1="16" stroke="#000" y2="17" x2="16"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 44, 24)">
                  <line xmlns="http://www.w3.org/2000/svg" stroke-width="2" y1="30" x1="44" stroke="#000" y2="18" x2="44"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 30, 20)">
                  <path xmlns="http://www.w3.org/2000/svg" stroke-width="2" fill="none" d="M 16 20 A 14 14 0 0 1 44 20" stroke="#000" stroke-linecap="butt"/>
              </g>
          </g>
      </svg>`,handles:"[]"},{id:"7328a097-72b5-4f47-9469-8b39a5646e30",name:"Bloqueo",description:"Zona de bloqueo",category:"seguridad",created_at:"2025-09-09T14:19:32+00:00",svg:`
      <svg xmlns="http://www.w3.org/2000/svg" style="background: rgba(255, 255, 255, 0);" viewBox="0 0 80 80">
          <defs xmlns="http://www.w3.org/2000/svg"/>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 40, 40)">
                  <circle xmlns="http://www.w3.org/2000/svg" cx="40" stroke="#3584e4" stroke-width="2" cy="40" fill="rgba(255, 255, 255, 0)" r="38"/>
              </g>
          </g>
      </svg>`,handles:"[]"},{id:"ca04f696-8e62-4250-82ef-be3f78d4eda9",name:"Puesta a Tierra",description:"Conexión a tierra",category:"seguridad",created_at:"2025-09-09T14:19:32+00:00",svg:`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" style="background: rgba(255, 255, 255, 0);">
          <defs xmlns="http://www.w3.org/2000/svg"/>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 20, 10)">
                  <line xmlns="http://www.w3.org/2000/svg" y2="20" y1="0" stroke="#000" x2="20" stroke-width="2" x1="20"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 20, 20)">
                  <line xmlns="http://www.w3.org/2000/svg" y2="20" y1="20" stroke="#000" x2="40" stroke-width="2" x1="0"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 20, 30)">
                  <line xmlns="http://www.w3.org/2000/svg" y2="30" y1="30" stroke="#000" x2="28" stroke-width="2" x1="12"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 20, 35)">
                  <line xmlns="http://www.w3.org/2000/svg" y2="35" y1="35" stroke="#000" x2="24" stroke-width="2" x1="16"/>
                  <g xmlns="http://www.w3.org/2000/svg"/>
              </g>
          </g>
          <g xmlns="http://www.w3.org/2000/svg">
              <g xmlns="http://www.w3.org/2000/svg" transform="rotate(0, 20, 25)">
                  <line xmlns="http://www.w3.org/2000/svg" y2="25" y1="25" stroke="#000" x2="36" stroke-width="2" x1="4"/>
              </g>
          </g>
      </svg>`,handles:JSON.stringify([{id:"top",x:20,y:0,type:"source"}])}],c=[...o,...a,...d,...x];try{await O.transaction("rw",O.svg_elements,async()=>{for(const l of c){if(await O.svg_elements.where("name").equalsIgnoreCase(l.name).and(S=>(S.category||"basic")===(l.category||"basic")).first())continue;const p={id:l.id,name:l.name,description:l.description||"",category:l.category||"basic",svg:l.svg,handles:l.handles||"",created_at:l.created_at||ye(),created_by:"pbarbeito",updated_at:l.created_at||ye(),updated_by:"pbarbeito",synchronized:!1,hidden:!1,local:!1};await O.svg_elements.add(p)}})}catch(l){console.error("Error inicializando elementos básicos:",l)}finally{St=null}})(),St)}const Zn=i=>{if(!i)return"";try{const o=new Date(i);if(Number.isNaN(o.getTime()))return i;const a=p=>String(p).padStart(2,"0"),d=a(o.getDate()),x=a(o.getMonth()+1),c=o.getFullYear(),l=a(o.getHours()),y=a(o.getMinutes());return`${d}/${x}/${c} ${l}:${y}`}catch{return i}},Qn=({element:i})=>{const o=Cr(),a=!!i.local,d=!!i.synchronized,x=a?"cloud_off":d?"cloud_done":"cloud_alert",c=a?o.palette.error.main:d?o.palette.success.main:o.palette.warning.main;return e.jsx("span",{style:{position:"absolute",right:6,top:6,zIndex:10},children:e.jsx("span",{className:"material-symbols-rounded",style:{color:c,fontSize:20},children:x})})},es=({onDragStart:i})=>{const[o,a]=N.useState({}),[d,x]=N.useState(!0),c=N.useCallback(async()=>{try{x(!0);const S=await jr();if(S.length===0){setTimeout(async()=>{const M=await jr();M.length>0&&l(M)},1e3);return}await l(S)}catch(S){console.error("Error cargando elementos de paleta:",S)}finally{x(!1)}},[]),l=async S=>{const M={};for(const _ of S)try{const T=(await Jn(_)).filter(K=>!K.hidden);T.length>0&&(M[_]=T)}catch(U){console.error(`Error cargando elementos de categoría ${_}:`,U)}a(M)};N.useEffect(()=>{c()},[c]),N.useEffect(()=>{const S=()=>{c()};return window.addEventListener("svg-elements-updated",S),()=>window.removeEventListener("svg-elements-updated",S)},[c]);const y=S=>{switch(S){case"transformadores":return"Transformadores";case"proteccion":return"Protecciones";case"infraestructura":return"Infraestructura";case"seguridad":return"Seguridad";case"mediciones":return"Mediciones";case"custom":return"Personalizados";default:return S.charAt(0).toUpperCase()+S.slice(1)}},p=S=>({Transformador:"trafo","Transformador 2 Bobinas":"trafo_2",Interruptor:"interruptor",Disconnector:"disconnector",Barras:"barras",Tierra:"tierra",Candado:"candado"})[S.name]||`db_${S.id}`;return d?e.jsxs(v,{sx:{position:"absolute",left:12,top:72,width:160,background:"rgba(0, 0, 0, 0.6)",p:1,borderRadius:1,zIndex:1200},children:[e.jsx(G,{variant:"h6",sx:{width:"100%",textAlign:"center",fontSize:14,fontWeight:600,mb:1,color:"white"},children:"Paleta"}),e.jsx(G,{variant:"body2",sx:{fontSize:12,color:"#fff"},children:"Cargando elementos..."})]}):e.jsxs(v,{sx:{position:"absolute",left:12,top:72,width:200,background:"rgba(0, 0, 0, 0.6)",p:2,borderRadius:6,zIndex:1200,display:"flex",flexDirection:"column",maxHeight:"calc(100vh - 96px)"},children:[e.jsxs(v,{sx:{display:"flex",justifyContent:"center",alignItems:"center"},children:[e.jsx(G,{variant:"h6",sx:{textAlign:"center",fontSize:14,fontWeight:600,color:"#fff"},children:"Paleta"}),e.jsx(lo,{title:"Sincronizar con servidor",children:e.jsx(Ie,{size:"small",color:"success",onClick:()=>{(async()=>{try{await Qt(),window.dispatchEvent(new Event("svg-elements-updated"))}catch(S){console.warn("Error sincronizando svgs con backend:",S),window.dispatchEvent(new Event("svg-elements-updated"))}})()},children:e.jsx("span",{className:"material-symbols-rounded",style:{color:"rgba(32, 255, 2, 1)"},children:"cloud_sync"})})})]}),e.jsx(v,{sx:{mt:1,flex:1,minHeight:0,overflowY:"auto",pr:1},children:Object.keys(o).length===0?e.jsx(G,{variant:"body2",sx:{fontSize:12,color:"#fff"},children:"No hay elementos disponibles. Crea algunos elementos SVG."}):Object.entries(o).map(([S,M])=>e.jsxs(hn,{defaultExpanded:S==="transformadores",sx:{marginBottom:1,backgroundColor:"rgba(0, 0, 0, 0.6)",color:"#fff"},children:[e.jsx(fn,{expandIcon:e.jsx("span",{className:"material-symbols-rounded",style:{color:"white"},children:"expand_more"}),sx:{padding:"4px 8px",minHeight:"32px",color:"#fff",borderRadius:"4px"},children:e.jsx(v,{sx:{display:"flex",alignItems:"center",gap:1},children:e.jsx(G,{variant:"body2",sx:{fontSize:12,fontWeight:600,color:"#fff"},children:y(S)})})}),e.jsx(pn,{sx:{padding:"8px 0"},children:e.jsx(v,{sx:{display:"flex",flexDirection:"column",gap:1},children:M.map(_=>e.jsxs(v,{draggable:!0,onDragStart:U=>i(U,p(_),_),sx:{position:"relative",display:"flex",alignItems:"center",gap:1,cursor:"grab",p:.5,border:"1px solid #ddd",borderRadius:1,background:"rgba(0, 0, 0, 0.6)",color:"#fff"},children:[e.jsx(Qn,{element:_}),e.jsx(v,{sx:{width:48,height:48,display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",backgroundColor:"#fff",border:"1px solid #eee",borderRadius:1},children:e.jsx("div",{dangerouslySetInnerHTML:{__html:(()=>{try{if(!_.svg)return"";const K=new DOMParser().parseFromString(_.svg,"image/svg+xml").documentElement;if(!K||K.nodeName.toLowerCase()!=="svg")return _.svg;const Z=K,ue=Z.getAttribute("viewBox"),V=Z.getAttribute("width"),ke=Z.getAttribute("height");if(!ue&&V&&ke){const be=parseFloat(V),Q=parseFloat(ke);!isNaN(be)&&!isNaN(Q)&&be>0&&Q>0&&Z.setAttribute("viewBox",`0 0 ${be} ${Q}`)}return Z.removeAttribute("width"),Z.removeAttribute("height"),Z.setAttribute("width","42"),Z.setAttribute("height","42"),Z.setAttribute("style","width:42px;height:42px;max-width:42px;max-height:42px;display:block"),new XMLSerializer().serializeToString(Z)}catch{return _.svg||""}})()}})}),e.jsx(v,{sx:{fontSize:10,flex:1,overflow:"hidden",textOverflow:"ellipsis"},children:_.name})]},_.id))})})]},S))})]})},ts=({id:i,data:o,selected:a})=>{const{symbolKey:d,isDynamicSvg:x,svg:c,handles:l}=o,[y,p]=w.useState(null);w.useEffect(()=>{x&&c&&l&&!y&&p({svg:c,handles:l})},[x,c,l,y,i]);const S=c||y?.svg,M=l||y?.handles;let _={w:48,h:48},U;if(x&&S){U=S;const z=S.match(/viewBox="([^"]+)"/);if(z){const he=z[1].split(" ").map(Number);he.length===4&&(_={w:he[2],h:he[3]})}}else console.error(`❌ PROBLEMA ENCONTRADO - Node ${i}: isDynamicSvg=true pero no hay svg en data ni preservado`,{dataKeys:Object.keys(o),hasPreservedData:!!y,fullData:o});const T=N.useRef(null),K=w.useMemo(()=>U?e.jsx("div",{ref:T,style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},dangerouslySetInnerHTML:{__html:U}},`svg-${i}`):e.jsx("div",{style:{width:"100%",height:"100%",backgroundColor:"#f0f0f0",border:"2px dashed #ccc",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"10px",color:"#666"},children:d||"ERROR"}),[U,d,i]);N.useEffect(()=>{if(!T.current)return;const z=T.current.querySelector("svg");if(!z)return;const he=o.backgroundColor,ee=o.primaryColor;try{const le=!!z.getAttribute("viewBox"),Ee=z.getAttribute("width"),fe=z.getAttribute("height");if(!le&&Ee&&fe){const ge=parseFloat(Ee),Ce=parseFloat(fe);!isNaN(ge)&&!isNaN(Ce)&&ge>0&&Ce>0&&z.setAttribute("viewBox",`0 0 ${ge} ${Ce}`)}if(z.setAttribute("width",String(_.w)),z.setAttribute("height",String(_.h)),ee)try{z.querySelectorAll("[stroke]").forEach(ge=>{ge.setAttribute("stroke",ee)}),z.querySelectorAll("[fill]").forEach(ge=>{ge.setAttribute("fill",ge.getAttribute("fill")==="none"?"none":ee)})}catch{}he&&(z.style.background=he),z.style.width="100%",z.style.height="100%",z.style.display="block",z.getAttribute("preserveAspectRatio")||z.setAttribute("preserveAspectRatio","xMidYMid meet")}catch{}},[U,_.w,_.h,o]);const Z=o.rotation??0,ue=o.scale??1,V=o.flipX??!1,ke=o.flipY??!1,je=o.invertHandles??!1,be=co();N.useEffect(()=>{!i||!be||requestAnimationFrame(()=>requestAnimationFrame(()=>be(i)))},[i,Z,ue,V,ke,be]);const Q=[];if(x&&M)try{const z=JSON.parse(M||"[]");(Array.isArray(z)?z:z&&typeof z=="object"?Object.values(z):[]).forEach(ee=>{const le=ee,Ee=Number(le.x??0)||0,fe=Number(le.y??0)||0,ge=Math.max(0,Math.min(Ee,_.w)),Ce=Math.max(0,Math.min(fe,_.h)),we=ge,ae=Math.abs(_.w-ge),b=Ce,te=Math.abs(_.h-Ce);let P=B.Left,oe=we;ae<oe&&(oe=ae,P=B.Right),b<oe&&(oe=b,P=B.Top),te<oe&&(oe=te,P=B.Bottom),Q.push({id:le.id??`h_${Math.floor(ge)}_${Math.floor(Ce)}`,position:P,type:le.type??"source",offset:void 0,absoluteX:ge,absoluteY:Ce})})}catch(z){console.warn("Error parsing dynamic handles:",z)}else switch(d){case"bus":Q.push({id:"left",position:B.Left,type:"source"}),Q.push({id:"right",position:B.Right,type:"source"});break;case"trafo":Q.push({id:"top",position:B.Top,type:"source"}),Q.push({id:"bottom",position:B.Bottom,type:"target"});break;case"trafo_2":Q.push({id:"top",position:B.Top,type:"source"}),Q.push({id:"left",position:B.Left,type:"target"}),Q.push({id:"right",position:B.Right,type:"target"});break;case"interruptor":Q.push({id:"left",position:B.Left,type:"source"}),Q.push({id:"right",position:B.Right,type:"target"});break;case"barras":Q.push({id:"r_top",position:B.Right,type:"target",offset:"20%"}),Q.push({id:"r_bottom",position:B.Right,type:"target",offset:"80%"}),Q.push({id:"t_left",position:B.Top,type:"source",offset:"20%"}),Q.push({id:"t_right",position:B.Top,type:"source",offset:"40%"}),Q.push({id:"b_left",position:B.Bottom,type:"target",offset:"20%"}),Q.push({id:"b_right",position:B.Bottom,type:"target",offset:"40%"});break;case"disconnector":Q.push({id:"left",position:B.Left,type:"source"}),Q.push({id:"right",position:B.Right,type:"source"});break;case"tierra":Q.push({id:"top",position:B.Top,type:"source"});break}const He=1,X=z=>Math.round(z/He)*He,Pe=(z,he,ee,le,Ee)=>{const fe=Ee*Math.PI/180,ge=Math.cos(fe),Ce=Math.sin(fe),we=z-ee,ae=he-le;return{x:ee+we*ge-ae*Ce,y:le+we*Ce+ae*ge}},pe=(z,he)=>{const ee=(he%360+360)%360;switch(z){case B.Top:return ee===90?B.Right:ee===180?B.Bottom:ee===270?B.Left:B.Top;case B.Right:return ee===90?B.Bottom:ee===180?B.Left:ee===270?B.Top:B.Right;case B.Bottom:return ee===90?B.Left:ee===180?B.Top:ee===270?B.Right:B.Bottom;case B.Left:return ee===90?B.Top:ee===180?B.Right:ee===270?B.Bottom:B.Left;default:return z}},W=(z,he,ee)=>{let le=z;if(he)switch(le){case B.Left:le=B.Right;break;case B.Right:le=B.Left;break}if(ee)switch(le){case B.Top:le=B.Bottom;break;case B.Bottom:le=B.Top;break}return le};return e.jsxs("div",{style:{position:"relative",display:"inline-flex",flexDirection:"column",alignItems:"center",gap:4,width:_.w,height:_.h,transformOrigin:"center center",padding:0},children:[Q.map(z=>{const he=je?z.type==="source"?"target":"source":z.type,ee=8,le=0,Ee={position:"absolute",background:he==="source"?"#22c55e":"#ef4444",width:ee,height:ee,borderRadius:ee/2,borderColor:"#111111",zIndex:10},fe={},ge=z.absoluteX,Ce=z.absoluteY;if(typeof ge=="number"&&typeof Ce=="number"){let ae=ge,b=Ce;if(V&&(ae=_.w-ae),ke&&(b=_.h-b),Z!==0){const te=Pe(ae,b,_.w/2,_.h/2,Z);ae=te.x,b=te.y}if(ue&&ue!==1){const te=_.w/2,P=_.h/2;ae=te+(ae-te)*ue,b=P+(b-P)*ue}ae=X(ae),b=X(b),fe.left=`${ae}px`,fe.top=`${b}px`,fe.transform="translate(-50%, -50%)"}else{const ae=_.w/2,b=_.h/2;let te,P;z.position===B.Right?(te=X(_.w+le),P=z.offset?typeof z.offset=="number"?X(z.offset):X(parseFloat(z.offset)/100*_.h):X(_.h/2)):z.position===B.Left?(te=X(-0),P=z.offset?typeof z.offset=="number"?X(z.offset):X(parseFloat(z.offset)/100*_.h):X(_.h/2)):z.position===B.Top?(te=z.offset?typeof z.offset=="number"?X(z.offset):X(parseFloat(z.offset)/100*_.w):X(_.w/2),P=X(-0)):(te=z.offset?typeof z.offset=="number"?X(z.offset):X(parseFloat(z.offset)/100*_.w):X(_.w/2),P=X(_.h+le));let oe=te,re=P;if(V&&(oe=_.w-oe),ke&&(re=_.h-re),Z!==0){const _e=Pe(oe,re,ae,b,Z);oe=_e.x,re=_e.y}ue&&ue!==1&&(oe=ae+(oe-ae)*ue,re=b+(re-b)*ue),oe=X(oe),re=X(re),fe.left=`${oe}px`,fe.top=`${re}px`,fe.transform="translate(-50%, -50%)"}let we=z.position;return we=W(we,V,ke),Z!==0&&(we=pe(we,Z)),e.jsx(mn,{id:z.id,type:he,position:we,style:{...Ee,...fe}},z.id)}),e.jsx("div",{style:{width:_.w,height:_.h,display:"flex",alignItems:"center",justifyContent:"center",transform:`rotate(${Z}deg) scale(${ue}) scaleX(${V?-1:1}) scaleY(${ke?-1:1})`,transformOrigin:"center center",border:a?"1px dashed rgba(33,150,243,0.8)":"none",borderRadius:a?"4px":"0",boxSizing:"border-box"},children:K})]})},rs=w.memo(ts),os=({id:i,data:o,selected:a})=>{const[d,x]=N.useState(!1),[c,l]=N.useState(o?.label??"Etiqueta"),y=N.useRef(null),p=co(),{setNodes:S}=yn();N.useEffect(()=>{l(o?.label??"Etiqueta")},[o?.label]),N.useEffect(()=>{d&&y.current&&(y.current.focus(),y.current.select())},[d]);const M=o?.fontSize??14,_=o?.color??"#000000",U=o?.backgroundColor??"rgba(255, 255, 255, 0)",T=o?.borderColor??"#000000",K=o?.borderWidth??0,Z=o?.rotation??0,ue=o?.scale??1,V=o?.flipX??!1,ke=o?.flipY??!1;N.useEffect(()=>{i&&p&&requestAnimationFrame(()=>requestAnimationFrame(()=>p(i)))},[i,Z,ue,V,ke,p]);const je=K&&K>0?`${K}px solid ${T}`:a?"1px dashed rgba(33,150,243,0.8)":"none";return e.jsx("div",{onDoubleClick:()=>x(!0),style:{display:"inline-flex",alignItems:"center",justifyContent:"center",padding:"4px 8px",cursor:"text",userSelect:"none",border:je,borderRadius:4,background:U,transform:`rotate(${Z}deg) scale(${ue}) scaleX(${V?-1:1}) scaleY(${ke?-1:1})`,transformOrigin:"center center"},children:d?e.jsx("input",{ref:y,value:c,onChange:be=>l(be.target.value),onBlur:()=>{x(!1);try{S(be=>be.map(Q=>Q.id===i?{...Q,data:{...Q.data,label:c}}:Q))}catch{}},onKeyDown:be=>{be.key==="Enter"&&be.target.blur()},style:{fontSize:M,color:_,border:"1px solid #ccc",padding:"2px 6px",borderRadius:4}}):e.jsx("div",{style:{fontSize:M,color:_},children:c})})},ns=({data:i,selected:o})=>{const{points:a=[],strokeColor:d=a.length>2?"#2196F3":"#000000",strokeWidth:x=2,strokeDasharray:c="5,5",fillColor:l=a.length>2?"#2196F3":"#000000",fillOpacity:y=.1}=i;if(a.length===0)return null;const p=Math.min(...a.map(V=>V.x)),S=Math.min(...a.map(V=>V.y)),M=Math.max(...a.map(V=>V.x)),_=Math.max(...a.map(V=>V.y)),U=0,T=M-p+U*2,K=_-S+U*2,Z=a.map(V=>({x:V.x-p+U,y:V.y-S+U})),ue=Z.length>0?`M ${Z[0].x} ${Z[0].y} `+Z.slice(1).map(V=>`L ${V.x} ${V.y}`).join(" ")+(Z.length>2?" Z":""):"";return e.jsx("div",{style:{width:T,height:K,position:"relative",pointerEvents:"auto"},children:e.jsxs("svg",{width:T,height:K,style:{position:"absolute",top:0,left:0,overflow:"visible"},children:[Z.length>2&&e.jsx("path",{d:ue,fill:l,fillOpacity:y,stroke:"none"}),e.jsx("path",{d:ue,fill:"none",stroke:d,strokeWidth:x,strokeDasharray:c,strokeLinecap:"round",strokeLinejoin:"round"}),o&&Z.map((V,ke)=>e.jsx("circle",{cx:V.x,cy:V.y,r:"4",fill:d,stroke:"#ffffff",strokeWidth:"2"},ke))]})})},ss={symbolNode:rs,labelNode:os,polygonNode:ns},as={type:"smoothstep",style:{strokeWidth:2,stroke:"#000000"}},is=[20,20],Xt=[];function ls(i){return Xt.push(i),()=>{const o=Xt.indexOf(i);o!==-1&&Xt.splice(o,1)}}function Jt(i){Xt.forEach(o=>{try{o(i)}catch{}})}const cs=()=>({notify:i=>{try{Jt(i)}catch{}}}),ao=5,Ve=20,ds=i=>({id:i,type:"rect",x:20,y:20,w:60,h:40,fill:!0,fillColor:"rgba(255, 255, 255, 0)",fillOpacity:0,strokeColor:"#000",strokeWidth:2,rotation:0,handles:[]}),us=i=>({id:i,type:"circle",x:60,y:60,r:30,fill:!0,fillColor:"rgba(255, 255, 255, 0)",fillOpacity:0,strokeColor:"#000",strokeWidth:2,rotation:0,handles:[]}),gs=i=>({id:i,type:"semicircle",x:60,y:60,r:30,fill:!1,fillColor:"none",fillOpacity:1,strokeColor:"#000",strokeWidth:2,rotation:0,handles:[]}),hs=i=>({id:i,type:"line",x1:60,y1:80,x2:60,y2:40,fill:!1,fillColor:"#000000",fillOpacity:1,strokeColor:"#000",strokeWidth:2,rotation:0,handles:[]}),fs=3,io="svgShapeEditor.draft.v1",ps=({width:i=120,height:o=120,onChange:a,displayScale:d})=>{const x=N.useRef(null),c=N.useRef(null),l=N.useRef(null),y=N.useRef(0),p=N.useRef(!1),S=N.useRef(null),M=N.useRef(!1),[_,U]=N.useState([]),[T,K]=N.useState(null),[Z,ue]=N.useState(null),[V,ke]=N.useState(i),[je,be]=N.useState(o),[Q,He]=N.useState(fs),X=typeof d=="number"?d:Q,Pe=N.useRef(null),pe=s=>{Pe.current=s},W=s=>Math.round(s/ao)*ao;N.useEffect(()=>{try{const s=localStorage.getItem(io);if(s){const t=JSON.parse(s);Array.isArray(t.shapes)&&U(t.shapes),typeof t.canvasWidth=="number"&&ke(t.canvasWidth),typeof t.canvasHeight=="number"&&be(t.canvasHeight),typeof t.displayScale=="number"&&typeof d!="number"&&He(t.displayScale)}}catch{}},[d]),N.useEffect(()=>(c.current&&window.clearTimeout(c.current),c.current=window.setTimeout(()=>{try{const s={shapes:_,canvasWidth:V,canvasHeight:je};typeof d!="number"&&(s.displayScale=Q),localStorage.setItem(io,JSON.stringify(s))}catch{}c.current=null},400),()=>{c.current&&(window.clearTimeout(c.current),c.current=null)}),[_,V,je,d,Q]),N.useEffect(()=>{if(a&&x.current)try{const s=x.current.cloneNode(!0);s.setAttribute("viewBox",`0 0 ${V} ${je}`),s.removeAttribute("width"),s.removeAttribute("height");try{Array.from(s.querySelectorAll('[data-editor-handle="true"]')).forEach(E=>E.parentNode?.removeChild(E)),Array.from(s.querySelectorAll('[data-editor-resize="true"]')).forEach(E=>E.parentNode?.removeChild(E)),Array.from(s.querySelectorAll('[data-editor-grid="true"]')).forEach(E=>E.parentNode?.removeChild(E)),Array.from(s.querySelectorAll("pattern#editor-grid, pattern#editor-grid-strong")).forEach(E=>E.parentNode?.removeChild(E))}catch{}const h=new XMLSerializer().serializeToString(s),u=_.flatMap(m=>m.handles.map(A=>({id:A.id,x:A.x,y:A.y,type:A.type})));a({svg:h,handles:u})}catch{const s=x.current.outerHTML;try{const t=new DOMParser().parseFromString(s,"image/svg+xml"),h=t.documentElement;h.setAttribute("viewBox",`0 0 ${V} ${je}`),h.removeAttribute("width"),h.removeAttribute("height"),Array.from(t.querySelectorAll('[data-editor-handle="true"]')).forEach(ne=>ne.parentNode?.removeChild(ne)),Array.from(t.querySelectorAll('[data-editor-resize="true"]')).forEach(ne=>ne.parentNode?.removeChild(ne)),Array.from(t.querySelectorAll('[data-editor-grid="true"]')).forEach(ne=>ne.parentNode?.removeChild(ne)),Array.from(t.querySelectorAll("pattern#editor-grid, pattern#editor-grid-strong")).forEach(ne=>ne.parentNode?.removeChild(ne));const E=new XMLSerializer().serializeToString(h),ie=_.flatMap(ne=>ne.handles.map(Ae=>({id:Ae.id,x:Ae.x,y:Ae.y,type:Ae.type})));a({svg:E,handles:ie});return}catch{const t=_.flatMap(h=>h.handles.map(u=>({id:u.id,x:u.x,y:u.y,type:u.type})));a({svg:s,handles:t})}}},[_,a,V,je]);const z=()=>{const s=`shape_${Date.now()}`;U(t=>[...t,ds(s)]),K(s)},he=()=>{const s=`shape_${Date.now()}`;U(t=>[...t,us(s)]),K(s)},ee=()=>{const s=`shape_${Date.now()}`;U(t=>[...t,gs(s)]),K(s)},le=()=>{const s=`shape_${Date.now()}`,t=hs(s);U(h=>[...h,t]),K(s)},Ee=(s,t,h)=>{s.stopPropagation(),s.button===0&&(K(t.id),pe({mode:"resize",shapeId:t.id,corner:h}),M.current||(window.addEventListener("mousemove",P),window.addEventListener("mouseup",oe),M.current=!0))},fe=(s,t)=>{s.stopPropagation(),s.button===0&&(K(t.id),pe({mode:"resize",shapeId:t.id,corner:"radius"}),M.current||(window.addEventListener("mousemove",P),window.addEventListener("mouseup",oe),M.current=!0))},ge=()=>{T&&(U(s=>s.filter(t=>t.id!==T)),K(null))};w.useEffect(()=>{const s=t=>{try{const h=document.activeElement,u=h?.tagName?.toLowerCase()||"";if(h?.isContentEditable||["input","textarea","select"].includes(u))return}catch{}if(t.key==="Delete"||t.key==="Backspace"){T&&(t.preventDefault(),U(h=>h.filter(u=>u.id!==T)),K(null));return}if((t.ctrlKey||t.metaKey)&&(t.key==="c"||t.key==="C")){if(T){t.preventDefault();const h=_.find(u=>u.id===T);if(h){const u=JSON.parse(JSON.stringify(h));S.current=[u]}}return}if((t.ctrlKey||t.metaKey)&&(t.key==="v"||t.key==="V")){const h=S.current;if(!h||h.length===0)return;t.preventDefault(),U(u=>{const m=h.map(k=>{const L=`shape_${Date.now()}_${Math.floor(Math.random()*1e4)}`,E=JSON.parse(JSON.stringify(k));return E.id=L,E.type==="rect"&&(E.x=(E.x||0)+10,E.y=(E.y||0)+10),(E.type==="circle"||E.type==="semicircle")&&(E.x=(E.x||0)+10,E.y=(E.y||0)+10),E.type==="line"&&(E.x1=(E.x1||0)+10,E.y1=(E.y1||0)+10,E.x2=(E.x2||0)+10,E.y2=(E.y2||0)+10),Array.isArray(E.handles)&&(E.handles=E.handles.map(ie=>({...ie,id:`h_${Date.now()}_${Math.floor(Math.random()*1e4)}`}))),E}),A=m[m.length-1];return setTimeout(()=>K(A.id),10),[...u,...m]});return}if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(t.key)){try{const A=document.activeElement,k=A?.tagName?.toLowerCase()||"";if(A?.isContentEditable||["input","textarea","select"].includes(k))return}catch{}t.preventDefault();const h={ArrowUp:[0,-1],ArrowDown:[0,1],ArrowLeft:[-1,0],ArrowRight:[1,0]},[u,m]=h[t.key];if(!T)return;U(A=>A.map(k=>{if(k.id!==T)return k;if(k.type==="rect")return{...k,x:k.x+u,y:k.y+m,handles:k.handles.map(L=>({...L,x:L.x+u,y:L.y+m}))};if(k.type==="circle"||k.type==="semicircle"){const L=k;return{...k,x:L.x+u,y:L.y+m,handles:k.handles.map(E=>({...E,x:E.x+u,y:E.y+m}))}}return k.type==="line"?{...k,x1:k.x1+u,y1:k.y1+m,x2:k.x2+u,y2:k.y2+m,handles:k.handles.map(L=>({...L,x:L.x+u,y:L.y+m}))}:k}));return}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[T,_]);const Ce=()=>{T&&U(s=>s.map(t=>{if(t.id!==T)return t;const h=`h_${Date.now()}`;let u=0,m=0;return t.type==="rect"?(u=W(t.x+t.w/2),m=W(t.y+t.h/2)):t.type==="circle"||t.type==="semicircle"?(u=W(t.x),m=W(t.y)):t.type==="line"&&(u=W((t.x1+t.x2)/2),m=W((t.y1+t.y2)/2)),{...t,handles:[...t.handles||[],{id:h,x:u,y:m,type:"source"}]}}))},we=(s,t)=>{if(!x.current)return null;const h=x.current.createSVGPoint();h.x=s,h.y=t;const u=x.current.getScreenCTM();return u?h.matrixTransform(u.inverse()):null},ae=(s,t)=>{if(s.stopPropagation(),s.button!==0)return;const h=we(s.clientX,s.clientY);h&&(p.current=!1,l.current={x:s.clientX,y:s.clientY},y.current=Date.now(),K(t.id),t.type==="rect"?pe({mode:"move",shapeId:t.id,offsetX:h.x-t.x,offsetY:h.y-t.y}):t.type==="circle"||t.type==="semicircle"?pe({mode:"move",shapeId:t.id,offsetX:h.x-t.x,offsetY:h.y-t.y}):t.type==="line"&&pe({mode:"move",shapeId:t.id,offsetX:h.x-t.x1,offsetY:h.y-t.y1}),M.current||(window.addEventListener("mousemove",P),window.addEventListener("mouseup",oe),M.current=!0))},b=(s,t,h)=>{s.stopPropagation(),s.button===0&&(pe({mode:"handle",shapeId:t,handleId:h}),M.current||(window.addEventListener("mousemove",P),window.addEventListener("mouseup",oe),M.current=!0))},te=(s,t,h)=>{s.stopPropagation(),s.button===0&&(K(t.id),pe({mode:"resize",shapeId:t.id,corner:h,offsetX:0,offsetY:0}),M.current||(window.addEventListener("mousemove",P),window.addEventListener("mouseup",oe),M.current=!0))},P=s=>{const t=we(s.clientX,s.clientY);t&&(p.current=!0,U(h=>h.map(u=>{const m=Pe.current;if(u.id!==(m&&m.shapeId))return u;if(m?.mode==="handle"&&m.handleId)return{...u,handles:u.handles.map(A=>A.id===m.handleId?{...A,x:W(t.x),y:W(t.y)}:A)};if(m?.mode==="move"){if(u.type==="rect"){const A=W(t.x-(m.offsetX||0)),k=W(t.y-(m.offsetY||0));return{...u,x:A,y:k}}if(u.type==="circle"||u.type==="semicircle"){const A=W(t.x-(m.offsetX||0)),k=W(t.y-(m.offsetY||0));return{...u,x:A,y:k}}if(u.type==="line"){const A=u.x2-u.x1,k=u.y2-u.y1,L=W(t.x-(m.offsetX||0)),E=W(t.y-(m.offsetY||0));return{...u,x1:L,y1:E,x2:L+A,y2:E+k}}}if(m?.mode==="resize"&&u.type==="rect"){const A=u.x,k=u.y,L=u.x+u.w,E=u.y+u.h;let ie=A,ne=k,Ae=L,We=E;m.corner==="nw"&&(ie=W(t.x),ne=W(t.y)),m.corner==="ne"&&(Ae=W(t.x),ne=W(t.y)),m.corner==="se"&&(Ae=W(t.x),We=W(t.y)),m.corner==="sw"&&(ie=W(t.x),We=W(t.y));const Fe=Math.max(8,Ae-ie),Be=Math.max(8,We-ne),Ze=Math.min(ie,Ae),Ct=Math.min(ne,We);return{...u,x:Ze,y:Ct,w:Fe,h:Be}}if(m?.mode==="resize"&&(u.type==="circle"||u.type==="semicircle")){const A=u;if(m.corner==="radius"){const k=t.x-A.x,L=t.y-A.y,E=Math.max(4,W(Math.sqrt(k*k+L*L)));return{...A,r:E}}}if(m?.mode==="resize"&&u.type==="line"){const A=u;if(m.corner==="p1"){const k=W(t.x),L=W(t.y),E=A.handles.map((ie,ne)=>ne===0?{...ie,x:k,y:L}:ie);return{...A,x1:k,y1:L,handles:E}}if(m.corner==="p2"){const k=W(t.x),L=W(t.y),E=A.handles.map((ie,ne)=>ne===1?{...ie,x:k,y:L}:ie);return{...A,x2:k,y2:L,handles:E}}}if(m?.mode==="resize"&&(u.type==="circle"||u.type==="semicircle")){const A=u;if(m.corner==="radius"){const k=t.x-A.x,L=t.y-A.y,E=Math.max(4,W(Math.sqrt(k*k+L*L)));return{...A,r:E}}}if(m?.mode==="resize"&&u.type==="line"){const A=u;if(m.corner==="p1"){const k=W(t.x),L=W(t.y),E=A.handles.map((ie,ne)=>ne===0?{...ie,x:k,y:L}:ie);return{...A,x1:k,y1:L,handles:E}}if(m.corner==="p2"){const k=W(t.x),L=W(t.y),E=A.handles.map((ie,ne)=>ne===1?{...ie,x:k,y:L}:ie);return{...A,x2:k,y2:L,handles:E}}}return u})))},oe=()=>{if(!Pe.current)return;const s=Pe.current?.shapeId;if(pe(null),l.current=null,M.current){try{window.removeEventListener("mousemove",P)}catch{}try{window.removeEventListener("mouseup",oe)}catch{}M.current=!1}s&&p.current?(K(s),setTimeout(()=>{p.current=!1},100)):p.current=!1},re=s=>{if(!Pe.current)return;const t=we(s.clientX,s.clientY);t&&(p.current=!0,U(h=>h.map(u=>{const m=Pe.current;if(u.id!==m?.shapeId)return u;if(m?.mode==="handle"&&m.handleId)return{...u,handles:u.handles.map(A=>A.id===m.handleId?{...A,x:W(t.x),y:W(t.y)}:A)};if(m?.mode==="move"){if(u.type==="rect"){const A=W(t.x-(m.offsetX||0)),k=W(t.y-(m.offsetY||0));return{...u,x:A,y:k}}if(u.type==="circle"){const A=W(t.x-(m.offsetX||0)),k=W(t.y-(m.offsetY||0));return{...u,x:A,y:k}}if(u.type==="line"){const A=u.x2-u.x1,k=u.y2-u.y1,L=W(t.x-(m.offsetX||0)),E=W(t.y-(m.offsetY||0));return{...u,x1:L,y1:E,x2:L+A,y2:E+k}}}if(m?.mode==="resize"&&u.type==="rect"){const A=u.x,k=u.y,L=u.x+u.w,E=u.y+u.h;let ie=A,ne=k,Ae=L,We=E;m.corner==="nw"&&(ie=W(t.x),ne=W(t.y)),m.corner==="ne"&&(Ae=W(t.x),ne=W(t.y)),m.corner==="se"&&(Ae=W(t.x),We=W(t.y)),m.corner==="sw"&&(ie=W(t.x),We=W(t.y));const Fe=Math.max(8,Ae-ie),Be=Math.max(8,We-ne),Ze=Math.min(ie,Ae),Ct=Math.min(ne,We);return{...u,x:Ze,y:Ct,w:Fe,h:Be}}return u})))},_e=()=>{const s=Pe.current?.shapeId;if(pe(null),l.current=null,M.current){try{window.removeEventListener("mousemove",P)}catch{}try{window.removeEventListener("mouseup",oe)}catch{}M.current=!1}s&&p.current?(K(s),setTimeout(()=>{p.current=!1},100)):p.current=!1},F=(s,t)=>{U(h=>h.map(u=>u.id!==s?u:{...u,handles:u.handles.map(m=>m.id===t?{...m,type:m.type==="source"?"target":"source"}:m)}))},Oe=(s,t,h)=>{U(u=>u.map(m=>m.id!==s?m:{...m,handles:m.handles.map(A=>A.id===t?{...A,type:h}:A)}))},Se=(s,t)=>{U(h=>h.map(u=>u.id===s?{...u,handles:u.handles.filter(m=>m.id!==t)}:u))},Me=s=>{U(t=>{const h=t.findIndex(A=>A.id===s);if(h===-1||h===t.length-1)return t;const u=t[h];return[...t.slice(0,h).concat(t.slice(h+1)),u]}),setTimeout(q,50)},R=s=>{U(t=>{const h=t.findIndex(A=>A.id===s);if(h<=0)return t;const u=t[h],m=t.slice(0,h).concat(t.slice(h+1));return[u,...m]}),setTimeout(q,50)},se=s=>{U(t=>{const h=t.findIndex(A=>A.id===s);if(h===-1||h>=t.length-1)return t;const u=t.slice(),m=u[h+1];return u[h+1]=u[h],u[h]=m,u}),setTimeout(q,50)},H=s=>{U(t=>{const h=t.findIndex(A=>A.id===s);if(h<=0)return t;const u=t.slice(),m=u[h-1];return u[h-1]=u[h],u[h]=m,u}),setTimeout(q,50)},I=s=>{T&&U(t=>t.map(h=>{if(h.id!==T)return h;const u={...h,...s};if(h.type==="line"){const m=u;if(Array.isArray(h.handles)&&h.handles.length>=2){const A=h.handles.map((k,L)=>L===0?{...k,x:m.x1,y:m.y1}:L===1?{...k,x:m.x2,y:m.y2}:k);u.handles=A}}return u}))},q=()=>{if(x.current)try{const s=x.current.cloneNode(!0);s.setAttribute("viewBox",`0 0 ${V} ${je}`),s.removeAttribute("width"),s.removeAttribute("height"),Array.from(s.querySelectorAll('[data-editor-handle="true"]')).forEach(k=>k.parentNode?.removeChild(k)),Array.from(s.querySelectorAll('[data-editor-resize="true"]')).forEach(k=>k.parentNode?.removeChild(k));const m=new XMLSerializer().serializeToString(s),A=_.flatMap(k=>k.handles.map(L=>({id:L.id,x:L.x,y:L.y,type:L.type})));a&&a({svg:m,handles:A})}catch{const s=x.current.outerHTML,t=_.flatMap(h=>h.handles.map(u=>({id:u.id,x:u.x,y:u.y,type:u.type})));a&&a({svg:s,handles:t})}},D=_.find(s=>s.id===T);return e.jsxs(v,{children:[e.jsxs(v,{sx:{display:"flex",gap:1,alignItems:"center",mb:1,flexWrap:"wrap"},children:[e.jsx(v,{children:e.jsx(J,{variant:"contained",startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"add_box"}),onClick:z,children:"Rectángulo"})}),e.jsx(v,{children:e.jsx(J,{variant:"contained",startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"radio_button_unchecked"}),onClick:he,children:"Círculo"})}),e.jsx(v,{children:e.jsx(J,{variant:"contained",startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"line_curve"}),onClick:ee,children:"Semicírculo"})}),e.jsx(v,{children:e.jsx(J,{variant:"contained",startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"horizontal_rule"}),onClick:le,children:"Línea"})}),e.jsx(v,{children:e.jsx(J,{variant:"outlined",color:"error",startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"delete"}),onClick:ge,disabled:!T,children:"Borrar"})}),e.jsx(v,{children:e.jsx(J,{variant:"outlined",onClick:Ce,startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"cable"}),disabled:!T,children:"Añadir handle"})}),e.jsxs(v,{sx:{ml:"auto",display:"flex",gap:1},children:[e.jsx(de,{label:"Ancho",type:"number",size:"small",value:V,slotProps:{input:{endAdornment:e.jsx(Qr,{position:"end",children:"px"})}},onChange:s=>ke(Number(s.target.value)||100),sx:{width:100,mr:1}}),e.jsx(de,{label:"Alto",type:"number",size:"small",value:je,slotProps:{input:{endAdornment:e.jsx(Qr,{position:"end",children:"px"})}},onChange:s=>be(Number(s.target.value)||100),sx:{width:100}})]})]}),e.jsxs(v,{sx:{display:"flex",gap:2,alignItems:"flex-start",flexWrap:"wrap"},children:[e.jsx(v,{sx:{border:"1px solid #ddd",width:V*X,height:je*X,overflow:"hidden"},children:e.jsxs("svg",{ref:x,viewBox:`0 0 ${V} ${je}`,width:V*X,height:je*X,style:{background:"rgba(255, 255, 255, 0.0)"},onMouseDown:s=>{s.target===x.current&&setTimeout(()=>{K(null),pe(null)},10)},onMouseMove:re,onMouseUp:_e,onMouseLeave:_e,children:[e.jsxs("defs",{children:[e.jsx("pattern",{id:"editor-grid",width:Ve,height:Ve,patternUnits:"userSpaceOnUse",children:e.jsx("path",{d:`M ${Ve} 0 L 0 0 0 ${Ve}`,fill:"none",stroke:"#ddd",strokeWidth:"0.5"})}),e.jsxs("pattern",{id:"editor-grid-strong",width:Ve*5,height:Ve*5,patternUnits:"userSpaceOnUse",children:[e.jsx("rect",{width:Ve*5,height:Ve*5,fill:"none"}),e.jsx("path",{d:`M ${Ve*5} 0 L 0 0 0 ${Ve*5}`,fill:"none",stroke:"#e6e6e6",strokeWidth:"1"})]})]}),e.jsx("rect",{"data-editor-grid":"true",x:0,y:0,width:V,height:je,fill:"url(#editor-grid)"}),_.map(s=>e.jsxs("g",{children:[s.type==="rect"&&(()=>{const t=s,h=t.x+t.w/2,u=t.y+t.h/2;return e.jsxs("g",{transform:`rotate(${t.rotation||0}, ${h}, ${u})`,children:[e.jsx("rect",{x:t.x,y:t.y,width:t.w,height:t.h,fill:t.fill?t.fillColor:"none",fillOpacity:typeof t.fillOpacity=="number"?t.fillOpacity:void 0,stroke:t.strokeColor,strokeWidth:t.strokeWidth,onMouseDown:m=>ae(m,t)}),T===t.id&&e.jsxs("g",{children:[e.jsx("rect",{"data-editor-resize":"true",x:t.x-3,y:t.y-3,width:6,height:6,fill:"#fff",stroke:"#666",onMouseDown:m=>te(m,t,"nw")}),e.jsx("rect",{"data-editor-resize":"true",x:t.x+t.w-3,y:t.y-3,width:6,height:6,fill:"#fff",stroke:"#666",onMouseDown:m=>te(m,t,"ne")}),e.jsx("rect",{"data-editor-resize":"true",x:t.x+t.w-3,y:t.y+t.h-3,width:6,height:6,fill:"#fff",stroke:"#666",onMouseDown:m=>te(m,t,"se")}),e.jsx("rect",{"data-editor-resize":"true",x:t.x-3,y:t.y+t.h-3,width:6,height:6,fill:"#fff",stroke:"#666",onMouseDown:m=>te(m,t,"sw")})]})]})})(),s.type==="circle"&&(()=>{const t=s,h=t.x,u=t.y;return e.jsxs("g",{transform:`rotate(${t.rotation||0}, ${h}, ${u})`,children:[e.jsx("circle",{cx:t.x,cy:t.y,r:t.r,fill:t.fill?t.fillColor:"none",fillOpacity:typeof t.fillOpacity=="number"?t.fillOpacity:void 0,stroke:t.strokeColor,strokeWidth:t.strokeWidth,onMouseDown:m=>ae(m,t)}),T===t.id&&e.jsx("g",{children:e.jsx("rect",{"data-editor-resize":"true",x:t.x+t.r-3,y:t.y-3,width:6,height:6,fill:"#fff",stroke:"#666",onMouseDown:m=>fe(m,t)})})]})})(),s.type==="semicircle"&&(()=>{const t=s,h=t.x,u=t.y,m=`M ${t.x-t.r} ${t.y} A ${t.r} ${t.r} 0 0 1 ${t.x+t.r} ${t.y}`;return e.jsxs("g",{transform:`rotate(${t.rotation||0}, ${h}, ${u})`,children:[e.jsx("path",{d:m,fill:"none",stroke:t.strokeColor,strokeWidth:t.strokeWidth,strokeLinecap:"butt",onMouseDown:A=>ae(A,t)}),T===t.id&&e.jsx("g",{children:e.jsx("rect",{"data-editor-resize":"true",x:t.x+t.r-3,y:t.y-3,width:6,height:6,fill:"#fff",stroke:"#666",onMouseDown:A=>fe(A,t)})})]})})(),s.type==="line"&&(()=>{const t=s,h=(t.x1+t.x2)/2,u=(t.y1+t.y2)/2;return e.jsxs("g",{transform:`rotate(${t.rotation||0}, ${h}, ${u})`,children:[e.jsx("line",{x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2,stroke:t.strokeColor,strokeWidth:t.strokeWidth,onMouseDown:m=>ae(m,t)}),T===t.id&&e.jsxs("g",{children:[e.jsx("rect",{"data-editor-resize":"true",x:t.x1-3,y:t.y1-3,width:6,height:6,fill:"#fff",stroke:"#666",onMouseDown:m=>Ee(m,t,"p1")}),e.jsx("rect",{"data-editor-resize":"true",x:t.x2-3,y:t.y2-3,width:6,height:6,fill:"#fff",stroke:"#666",onMouseDown:m=>Ee(m,t,"p2")})]})]})})(),s.handles.map(t=>e.jsx("circle",{cx:t.x,cy:t.y,r:6,fill:t.type==="source"?"#22c55e":"#ef4444",stroke:"#111","data-editor-handle":"true",onMouseDown:h=>b(h,s.id,t.id),onClick:h=>{h.stopPropagation(),ue(t.id),K(s.id)},onDoubleClick:h=>{h.stopPropagation(),F(s.id,t.id),ue(t.id),K(s.id)},onContextMenu:h=>{h.preventDefault(),h.stopPropagation(),Se(s.id,t.id),ue(null)},style:{cursor:"grab"}},t.id))]},s.id))]})}),e.jsxs(v,{sx:{display:"flex",gap:2,flex:"1 1 50%",minWidth:260},children:[e.jsxs(v,{sx:{flex:"1 1 50%",minWidth:220},children:[e.jsx(G,{variant:"subtitle1",children:"Propiedades"}),!T&&e.jsx(G,{variant:"body2",color:"text.secondary",children:"Selecciona una forma para editar sus propiedades"}),T&&D&&e.jsxs(v,{sx:{mt:1,display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(G,{variant:"caption",children:["Tipo: ",D.type]}),e.jsx(Kt,{control:e.jsx(Vt,{checked:!!D.fill,onChange:s=>I({fill:s.target.checked})}),label:"Relleno"}),e.jsx(de,{type:"color",label:"Color de relleno",size:"small",sx:{width:140},value:D.fillColor||"#000000",onChange:s=>I({fillColor:s.target.value})}),e.jsxs(v,{children:[e.jsx(G,{variant:"caption",children:"Opacidad de relleno"}),e.jsx(br,{min:0,max:1,step:.01,value:typeof D.fillOpacity=="number"?D.fillOpacity:1,onChange:(s,t)=>I({fillOpacity:Array.isArray(t)?t[0]:t})})]}),e.jsx(v,{children:e.jsx(de,{type:"color",label:"Color de trazo",size:"small",sx:{width:140},value:D.strokeColor||"#000000",onChange:s=>I({strokeColor:s.target.value})})}),e.jsxs(v,{children:[e.jsx(G,{variant:"caption",children:"Ancho de trazo"}),e.jsx(br,{min:0,max:10,value:D.strokeWidth??1,onChange:(s,t)=>I({strokeWidth:Array.isArray(t)?t[0]:t})})]}),e.jsx(v,{children:e.jsx(de,{type:"number",label:"Rotación (°)",value:D.rotation??0,onChange:s=>I({rotation:Number(s.target.value)||0})})})]})]}),e.jsxs(v,{sx:{flex:"1 1 50%",minWidth:220},children:[(!T||!D)&&e.jsx(v,{sx:{mt:1}}),T&&D&&e.jsxs(v,{sx:{mt:1,display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(v,{children:[e.jsx(G,{variant:"subtitle2",children:"Handles"}),D.handles.length===0&&e.jsx(G,{variant:"body2",color:"text.secondary",children:"No tiene handles"}),D.handles.length>0&&e.jsxs(v,{sx:{display:"flex",flexDirection:"column",gap:1,mt:1},children:[D.handles.map(s=>e.jsxs(v,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(J,{size:"small",variant:Z===s.id?"contained":"outlined",onClick:()=>{ue(s.id),K(D.id)},children:s.id}),e.jsx(J,{size:"small",onClick:()=>F(D.id,s.id),color:s?.type==="source"?"success":"error",variant:"outlined",children:(s?.type??"").toUpperCase()}),e.jsx(J,{size:"small",color:"error",onClick:()=>Se(D.id,s.id),children:"Eliminar"})]},s.id)),Z&&e.jsxs(v,{sx:{mt:1},children:[e.jsx(G,{variant:"caption",children:"Tipo del handle seleccionado"}),e.jsxs(v,{sx:{display:"flex",gap:1,mt:.5},children:[e.jsx(J,{variant:D.handles.find(t=>t.id===Z)?.type==="source"?"contained":"outlined",color:"success",onClick:()=>{const s=Z;s&&Oe(D.id,s,"source")},children:"SOURCE"}),e.jsx(J,{variant:D.handles.find(t=>t.id===Z)?.type==="target"?"contained":"outlined",color:"error",onClick:()=>{const s=Z;s&&Oe(D.id,s,"target")},children:"TARGET"})]})]})]})]}),D.type==="rect"&&e.jsx(e.Fragment,{children:e.jsxs(v,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(de,{fullWidth:!0,label:"X",type:"number",size:"small",value:D.x,onChange:s=>I({x:Number(s.target.value)})}),e.jsx(de,{fullWidth:!0,label:"Y",type:"number",size:"small",value:D.y,onChange:s=>I({y:Number(s.target.value)})}),e.jsx(de,{fullWidth:!0,label:"W",type:"number",size:"small",value:D.w,onChange:s=>I({w:Number(s.target.value)})}),e.jsx(de,{fullWidth:!0,label:"H",type:"number",size:"small",value:D.h,onChange:s=>I({h:Number(s.target.value)})})]})}),D.type==="circle"&&e.jsx(e.Fragment,{children:e.jsxs(v,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(de,{fullWidth:!0,label:"CX",type:"number",size:"small",value:D.x,onChange:s=>I({x:Number(s.target.value)})}),e.jsx(de,{fullWidth:!0,label:"CY",type:"number",size:"small",value:D.y,onChange:s=>I({y:Number(s.target.value)})}),e.jsx(de,{fullWidth:!0,sx:{gridColumn:"1 / -1"},label:"R",type:"number",size:"small",value:D.r,onChange:s=>I({r:Number(s.target.value)})})]})}),D.type==="semicircle"&&e.jsx(e.Fragment,{children:e.jsxs(v,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(de,{fullWidth:!0,label:"CX",type:"number",size:"small",value:D.x,onChange:s=>I({x:Number(s.target.value)})}),e.jsx(de,{fullWidth:!0,label:"CY",type:"number",size:"small",value:D.y,onChange:s=>I({y:Number(s.target.value)})}),e.jsx(de,{fullWidth:!0,sx:{gridColumn:"1 / -1"},label:"R",type:"number",size:"small",value:D.r,onChange:s=>I({r:Number(s.target.value)})})]})}),D.type==="line"&&e.jsx(e.Fragment,{children:e.jsxs(v,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:1},children:[e.jsx(de,{fullWidth:!0,label:"X1",type:"number",size:"small",value:D.x1,onChange:s=>I({x1:Number(s.target.value)})}),e.jsx(de,{fullWidth:!0,label:"Y1",type:"number",size:"small",value:D.y1,onChange:s=>I({y1:Number(s.target.value)})}),e.jsx(de,{fullWidth:!0,label:"X2",type:"number",size:"small",value:D.x2,onChange:s=>I({x2:Number(s.target.value)})}),e.jsx(de,{fullWidth:!0,label:"Y2",type:"number",size:"small",value:D.y2,onChange:s=>I({y2:Number(s.target.value)})})]})}),e.jsxs(v,{sx:{display:"flex",gap:1,flexWrap:"wrap",alignItems:"center",mt:1},children:[e.jsxs(v,{sx:{flexGrow:1,display:"flex",gap:1,minWidth:120},children:[e.jsx(J,{fullWidth:!0,variant:"outlined",onClick:()=>T&&se(T),disabled:!T,children:"Subir"}),e.jsx(J,{fullWidth:!0,variant:"outlined",onClick:()=>T&&H(T),disabled:!T,children:"Bajar"})]}),e.jsxs(v,{sx:{flexGrow:1,display:"flex",gap:1,minWidth:120},children:[e.jsx(J,{fullWidth:!0,variant:"outlined",onClick:()=>T&&Me(T),disabled:!T,children:"Traer arriba"}),e.jsx(J,{fullWidth:!0,variant:"outlined",onClick:()=>T&&R(T),disabled:!T,children:"Enviar abajo"})]}),e.jsx(J,{fullWidth:!0,variant:"contained",sx:{ml:"auto"},onClick:q,children:"Aplicar"})]})]})]})]})]})]})},ms=({open:i,onClose:o,svgName:a,setSvgName:d,svgDescription:x,setSvgDescription:c,svgCategory:l,setSvgCategory:y,categories:p,svgHandles:S,setSvgHandles:M,svgMarkup:_,setSvgMarkup:U,useEditor:T,setUseEditor:K,sanitizedSvg:Z,svgElements:ue,onSaveSvgElement:V})=>{const ke=({element:b})=>{const te=Cr(),P=!!b.local,oe=!!b.synchronized,re=P?"cloud_off":oe?"cloud_done":"cloud_alert",_e=P?te.palette.error.main:oe?te.palette.success.main:te.palette.warning.main;return e.jsx("span",{style:{position:"absolute",right:8,top:8,zIndex:20},children:e.jsx("span",{className:"material-symbols-rounded",style:{color:_e,fontSize:25},children:re})})},[je,be]=w.useState(Date.now()),[Q,He]=w.useState(void 0),[X,Pe]=w.useState("all"),[pe,W]=w.useState(""),[z,he]=w.useState(!1),[ee,le]=w.useState(!1),[Ee,fe]=w.useState(null),ge="svgShapeEditor.draft.v1",Ce=()=>{try{d(""),c(""),y("custom"),M(""),U(""),localStorage.removeItem(ge),K(!0),be(Date.now())}catch(b){console.error("Error limpiando editor SVG",b)}},we=b=>{try{const P=new DOMParser().parseFromString(b.svg||"","image/svg+xml"),oe=P.querySelector("svg");let re=120,_e=120;if(oe){const R=oe.getAttribute("viewBox");if(R){const se=R.split(/[ ,]+/).map(H=>parseFloat(H)).filter(H=>!isNaN(H));se.length===4&&(re=Math.abs(se[2])||re,_e=Math.abs(se[3])||_e)}else{const se=oe.getAttribute("width"),H=oe.getAttribute("height"),I=se?parseFloat(se.toString().replace(/[^0-9.-]/g,"")):NaN,q=H?parseFloat(H.toString().replace(/[^0-9.-]/g,"")):NaN;!isNaN(I)&&!isNaN(q)&&(re=I,_e=q)}}let F=[];try{F=b.handles?typeof b.handles=="string"?JSON.parse(b.handles):b.handles:[]}catch{F=[]}let Oe=[];Array.isArray(F)&&(Oe=F.map((R,se)=>{const H=R,I=H&&typeof H.id=="string"?H.id:`h_${se}`,q=H&&(typeof H.x=="number"||typeof H.x=="string")?Number(H.x):0,D=H&&(typeof H.y=="number"||typeof H.y=="string")?Number(H.y):0,s=H&&typeof H.type=="string"?H.type:"source";return{id:I,x:q,y:D,type:s}}));const Se=[],Me=R=>{let se=0,H=R;for(;H;){const q=(H.getAttribute("transform")||"").match(/rotate\(([^)]+)\)/);if(q){const D=q[1].split(/[ ,]+/).map(s=>parseFloat(s)).filter(s=>!isNaN(s));D.length>0&&(se+=D[0]||0)}H=H.parentElement}return se};if(Array.from(P.querySelectorAll("rect")).forEach((R,se)=>{const H=parseFloat(R.getAttribute("x")||"0"),I=parseFloat(R.getAttribute("y")||"0"),q=parseFloat(R.getAttribute("width")||"0"),D=parseFloat(R.getAttribute("height")||"0"),s=R.getAttribute("fill"),t=R.getAttribute("stroke")||"#000",h=parseFloat(R.getAttribute("stroke-width")||"1"),u=Me(R);Se.push({id:`shape_import_rect_${b.id}_${se}_${Date.now()}`,type:"rect",x:H,y:I,w:q,h:D,fill:!!(s&&s!=="none"),fillColor:s||"rgba(255,255,255,0)",strokeColor:t,strokeWidth:h||1,rotation:u||0,handles:[]})}),Array.from(P.querySelectorAll("circle")).forEach((R,se)=>{const H=parseFloat(R.getAttribute("cx")||"0"),I=parseFloat(R.getAttribute("cy")||"0"),q=parseFloat(R.getAttribute("r")||"0"),D=R.getAttribute("fill"),s=R.getAttribute("stroke")||"#000",t=parseFloat(R.getAttribute("stroke-width")||"1"),h=Me(R);Se.push({id:`shape_import_circle_${b.id}_${se}_${Date.now()}`,type:"circle",x:H,y:I,r:q,fill:!!(D&&D!=="none"),fillColor:D||"rgba(255,255,255,0)",strokeColor:s,strokeWidth:t||1,rotation:h||0,handles:[]})}),Array.from(P.querySelectorAll("line")).forEach((R,se)=>{const H=parseFloat(R.getAttribute("x1")||"0"),I=parseFloat(R.getAttribute("y1")||"0"),q=parseFloat(R.getAttribute("x2")||"0"),D=parseFloat(R.getAttribute("y2")||"0"),s=R.getAttribute("stroke")||"#000",t=parseFloat(R.getAttribute("stroke-width")||"1"),h=Me(R);Se.push({id:`shape_import_line_${b.id}_${se}_${Date.now()}`,type:"line",x1:H,y1:I,x2:q,y2:D,fill:!1,fillColor:"none",strokeColor:s,strokeWidth:t||1,rotation:h||0,handles:[]})}),Array.from(P.querySelectorAll("polyline")).forEach((R,se)=>{const H=(R.getAttribute("points")||"").trim();if(!H)return;const I=H.match(/[+-]?(?:\d*\.)?\d+(?:[eE][+-]?\d+)?/g)?.map(q=>parseFloat(q))||[];if(I.length>=4){const q=I[0],D=I[1],s=I[2],t=I[3],h=R.getAttribute("stroke")||"#000",u=parseFloat(R.getAttribute("stroke-width")||"1"),m=Me(R);Se.push({id:`shape_import_polyline_${b.id}_${se}_${Date.now()}`,type:"line",x1:q,y1:D,x2:s,y2:t,fill:!1,fillColor:"none",strokeColor:h,strokeWidth:u||1,rotation:m||0,handles:[]})}}),Array.from(P.querySelectorAll("path")).forEach((R,se)=>{const H=(R.getAttribute("d")||"").trim();if(!H)return;try{const q=H.match(/[AaMmLlHhVvCcSsQqTtZz]|[+-]?(?:\d*\.)?\d+(?:[eE][+-]?\d+)?/g)||[];let D=null,s=null;for(let h=0;h<q.length;h++){const u=q[h];if((u==="M"||u==="m")&&h+2<q.length){D=parseFloat(q[h+1]),s=parseFloat(q[h+2]);break}}let t=-1;for(let h=0;h<q.length;h++)if(q[h]==="A"||q[h]==="a"){t=h;break}if(t!==-1&&D!==null&&s!==null){const h=parseFloat(q[t+1]),u=parseFloat(q[t+2]),m=parseFloat(q[t+3])||0;let A=parseFloat(q[t+6]),k=parseFloat(q[t+7]);q[t]==="a"&&(A=D+A,k=s+k);const L=A-D,E=k-s,ie=Math.hypot(L,E),ne=Math.max(1,Math.min(4,h*.1));if(!isNaN(h)&&!isNaN(u)&&Math.abs(h-u)<1e-4&&Math.abs(ie-2*h)<=ne){const Ae=(D+A)/2,We=(s+k)/2,Fe=R.getAttribute("stroke")||"#000",Be=parseFloat(R.getAttribute("stroke-width")||"1"),Ze=(Me(R)||0)+(m||0);Se.push({id:`shape_import_semi_${b.id}_${se}_${Date.now()}`,type:"semicircle",x:Ae,y:We,r:h,fill:!1,fillColor:"none",strokeColor:Fe,strokeWidth:Be||1,rotation:Ze||0,handles:[]});return}}}catch{}const I=H.match(/[+-]?(?:\d*\.)?\d+(?:[eE][+-]?\d+)?/g)?.map(q=>parseFloat(q))||[];if(I.length>=4){const q=I[0],D=I[1],s=I[2],t=I[3],h=R.getAttribute("stroke")||"#000",u=parseFloat(R.getAttribute("stroke-width")||"1"),m=Me(R);Se.push({id:`shape_import_path_${b.id}_${se}_${Date.now()}`,type:"line",x1:q,y1:D,x2:s,y2:t,fill:!1,fillColor:"none",strokeColor:h,strokeWidth:u||1,rotation:m||0,handles:[]})}}),Se.length>0){const R=(I,q,D,s)=>(I-D)*(I-D)+(q-s)*(q-s),se=I=>I.type==="rect"?{x:(I.x||0)+(I.w||0)/2,y:(I.y||0)+(I.h||0)/2}:I.type==="circle"?{x:I.x||0,y:I.y||0}:I.type==="line"?{x:((I.x1||0)+(I.x2||0))/2,y:((I.y1||0)+(I.y2||0))/2}:{x:0,y:0};Oe.forEach((I,q)=>{let D=0,s=1/0;for(let h=0;h<Se.length;h++){const u=se(Se[h]),m=R(I.x||0,I.y||0,u.x,u.y);m<s&&(s=m,D=h)}const t=Se[D];t.handles=t.handles||[],t.handles.push({id:I.id||`h_${q}`,x:I.x||0,y:I.y||0,type:I.type||"source"})});const H={shapes:Se,canvasWidth:re,canvasHeight:_e};localStorage.setItem(ge,JSON.stringify(H))}else{const se={shapes:[{id:`shape_import_${b.id}_${Date.now()}`,type:"rect",x:0,y:0,w:0,h:0,fill:!1,fillColor:"rgba(255,255,255,0)",strokeColor:"none",strokeWidth:0,rotation:0,handles:Oe}],canvasWidth:re,canvasHeight:_e};localStorage.setItem(ge,JSON.stringify(se))}K(!0),be(Date.now())}catch(te){console.error("Error copiando elemento al editor",te);try{Jt({message:"Error copiando elemento al editor",severity:"error"})}catch{}}},ae=(b,te,P)=>{if(!b)return"";try{const _e=new DOMParser().parseFromString(b,"image/svg+xml").documentElement;if(!_e||_e.nodeName.toLowerCase()!=="svg")return b;const F=_e,Oe=F.getAttribute("viewBox"),Se=F.getAttribute("width"),Me=F.getAttribute("height");if(!Oe&&Se&&Me){const se=parseFloat(Se),H=parseFloat(Me);!isNaN(se)&&!isNaN(H)&&se>0&&H>0&&F.setAttribute("viewBox",`0 0 ${se} ${H}`)}return F.removeAttribute("width"),F.removeAttribute("height"),F.setAttribute("width",String(te)),F.setAttribute("height",String(P)),F.setAttribute("style",`width:${te}px;height:${P}px;display:block`),new XMLSerializer().serializeToString(F)}catch{return b}};return e.jsxs(dt,{open:i,onClose:o,maxWidth:"xl",fullWidth:!0,sx:{borderRadius:4},children:[e.jsx(ut,{sx:{textAlign:"center",backgroundColor:"#263238",color:"#fff",fontSize:18,fontWeight:400,padding:"12px 16px"},children:"Crear/Editar Elemento SVG"}),e.jsxs(gt,{sx:{mt:2},children:[e.jsx(de,{autoFocus:!0,margin:"dense",label:"Nombre",fullWidth:!0,variant:"outlined",value:a,onChange:b=>d(b.target.value)}),e.jsx(de,{margin:"dense",label:"Descripción (opcional)",fullWidth:!0,variant:"outlined",value:x,onChange:b=>c(b.target.value)}),e.jsxs(vr,{margin:"dense",fullWidth:!0,variant:"outlined",children:[e.jsx(Sr,{children:"Categoría"}),e.jsxs(kr,{value:l,onChange:b=>y(b.target.value),label:"Categoría",children:[e.jsx(Le,{value:"custom",children:"Personalizado"}),e.jsx(Le,{value:"mediciones",children:"Mediciones"}),e.jsx(Le,{value:"infraestructura",children:"Infraestructura"}),e.jsx(Le,{value:"proteccion",children:"Protecciones"}),e.jsx(Le,{value:"seguridad",children:"Seguridad"}),e.jsx(Le,{value:"transformadores",children:"Transformadores"}),p.filter(b=>!["custom","mediciones","infraestructura","proteccion","seguridad","transformadores"].includes(b)).map(b=>e.jsx(Le,{value:b,children:b},b))]})]}),e.jsxs(v,{style:{display:"flex",gap:8,alignItems:"center",marginTop:8},children:[e.jsx(Kt,{control:e.jsx(Vt,{checked:T,onChange:b=>K(b.target.checked)}),label:"Usar editor gráfico"}),T&&e.jsxs(e.Fragment,{children:[e.jsx(G,{id:"input-slider",sx:{mr:2},children:"Escala del editor:"}),e.jsx(v,{sx:{width:300},children:e.jsx(br,{"aria-label":"Custom marks",defaultValue:3,getAriaValueText:()=>typeof Q=="number"?Q.toFixed(1):"3",step:.1,min:.5,max:6,value:typeof Q=="number"?Q:3,onChange:(b,te)=>He(typeof te=="number"?te:3),marks:[{value:.5,label:"0.5x"},{value:1,label:"1x"},{value:2,label:"2x"},{value:3,label:"3x"},{value:4,label:"4x"},{value:5,label:"5x"},{value:6,label:"6x"}],valueLabelDisplay:"auto"})})]})]}),T?e.jsx(e.Fragment,{children:e.jsx(v,{style:{marginTop:8,border:"1px solid #ddd",padding:8},children:e.jsx(ps,{width:120,height:120,onChange:b=>{U(typeof b.svg=="string"?b.svg:"");try{M(JSON.stringify(b.handles||[]))}catch{M("[]")}},displayScale:typeof Q=="number"?Q:void 0,onDisplayScaleChange:b=>He(b)},je)})}):e.jsxs(e.Fragment,{children:[e.jsx(de,{margin:"dense",label:"Handles (JSON)",fullWidth:!0,variant:"outlined",value:S,onChange:b=>M(b.target.value),helperText:'Ej: [{"id":"h_1756916462310","x":30,"y":45,"type":"source"}]'}),e.jsx(de,{margin:"dense",label:"SVG markup",fullWidth:!0,variant:"outlined",multiline:!0,rows:8,value:_,onChange:b=>U(b.target.value)}),e.jsxs(v,{style:{marginTop:8},children:[e.jsx(G,{variant:"subtitle2",children:"Previsualización"}),e.jsx("div",{style:{border:"1px solid #ddd",padding:8,borderRadius:4,background:"#fff"},children:Z?e.jsx("div",{dangerouslySetInnerHTML:{__html:ae(Z,160,160)}}):_?e.jsx("div",{dangerouslySetInnerHTML:{__html:ae(_,160,160)}}):e.jsx("div",{style:{color:"#888"},children:"Sin contenido"})})]})]}),e.jsxs(v,{style:{marginTop:12},children:[e.jsx(G,{variant:"subtitle2",children:"Elementos guardados"}),e.jsxs(v,{style:{marginTop:8},children:[e.jsxs(v,{sx:{display:"flex",gap:1,alignItems:"center",mb:1,flexWrap:"wrap"},children:[e.jsxs(vr,{size:"small",sx:{minWidth:160},children:[e.jsx(Sr,{children:"Filtrar categoría"}),e.jsxs(kr,{value:X,label:"Filtrar categoría",onChange:b=>Pe(String(b.target.value)),children:[e.jsx(Le,{value:"all",children:"Todas"}),p.map(b=>e.jsx(Le,{value:b,children:b},b)),e.jsx(Le,{value:"eliminados",children:"Eliminados"})]})]}),e.jsx(de,{size:"small",placeholder:"Buscar por nombre o descripción",value:pe,onChange:b=>W(b.target.value),sx:{minWidth:240,flex:1}}),e.jsx(lo,{title:"Sincronizar con servidor",children:e.jsx(Ie,{size:"small",color:"success",onClick:()=>{(async()=>{try{await Qt(),window.dispatchEvent(new Event("svg-elements-updated"))}catch(b){console.warn("Error sincronizando svgs con backend:",b),window.dispatchEvent(new Event("svg-elements-updated"))}})()},title:"Sincronizar con servidor",children:e.jsx("span",{className:"material-symbols-rounded",style:{color:"rgba(36, 168, 19, 1)"},children:"cloud_sync"})})})]}),(()=>{const b=(pe||"").trim().toLowerCase(),te=ue.filter(P=>{if(X==="eliminados"){if(!P.hidden)return!1}else if(P.hidden)return!1;if(X!=="all"&&X!=="eliminados"&&(P.category||"custom")!==X)return!1;if(!b)return!0;const oe=(P.name||"").toLowerCase(),re=(P.description||"").toLowerCase();return oe.includes(b)||re.includes(b)});return te.length===0?e.jsx(G,{variant:"body2",style:{color:"#666"},children:"No hay elementos que coincidan"}):e.jsx(v,{sx:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(220px, 1fr))",gap:12},children:te.map(P=>e.jsxs(v,{sx:{position:"relative",width:"100%",border:"1px solid #eee",borderRadius:2,background:"#fff",overflow:"hidden",transition:"transform 150ms ease, box-shadow 150ms ease","&:hover":{transform:"translateY(-6px)",boxShadow:3}},children:[e.jsx(ke,{element:P}),e.jsx("div",{style:{width:"100%",height:120,display:"flex",alignItems:"center",justifyContent:"center",borderBottom:"1px solid #f0f0f0",padding:8,boxSizing:"border-box",background:"#fff"},children:e.jsx("div",{dangerouslySetInnerHTML:{__html:ae(P.svg||"",96,96)}})}),e.jsxs(v,{sx:{p:1},children:[e.jsx(G,{variant:"body2",sx:{fontWeight:600,textAlign:"center"},children:P.name}),e.jsx(G,{variant:"caption",sx:{color:"#666",display:"block"},children:P.description}),e.jsxs(G,{variant:"caption",sx:{color:"#444",display:"block",mt:.75},children:["Creado por: ",P.created_by||"desconocido"]}),e.jsxs(G,{variant:"caption",sx:{color:"#444",display:"block",mt:.75},children:["Fecha: ",Zn(P.created_at)||"desconocido"]}),e.jsxs(v,{sx:{display:"flex",gap:1,mt:1,flexWrap:"wrap"},children:[e.jsx(J,{size:"small",onClick:()=>we(P),children:"Copiar al editor"}),P.hidden?e.jsx(J,{size:"small",color:"success",onClick:()=>{(async()=>{if(P.id)try{await so(String(P.id),{hidden:!1});try{Jt({message:`Elemento "${P.name}" restaurado`,severity:"success"})}catch{}}catch(oe){console.error("Failed to restore svg",P.id,oe)}finally{try{window.dispatchEvent(new Event("svg-elements-updated"))}catch{}}})()},children:"Restaurar"}):e.jsx(J,{size:"small",color:"error",onClick:()=>{fe(P),le(!0)},children:"Eliminar"})]})]})]},P.id))})})()]})]})]}),e.jsxs(dt,{open:ee,onClose:()=>{le(!1),fe(null)},children:[e.jsx(ut,{sx:{textAlign:"center",backgroundColor:"#263238",color:"#fff",fontSize:18,fontWeight:400,padding:"12px 16px"},children:"Marcar como eliminado"}),e.jsx(gt,{sx:{mt:2},children:e.jsxs(G,{children:['¿Deseas marcar como eliminado el elemento "',Ee?.name,'"? Esto lo ocultará en la paleta y editor; el servidor no será modificado.']})}),e.jsxs(ht,{children:[e.jsx(J,{onClick:()=>{le(!1),fe(null)},color:"secondary",children:"Cancelar"}),e.jsx(J,{color:"error",onClick:()=>{(async()=>{if(!Ee||!Ee.id){le(!1),fe(null);return}const b=String(Ee.id);try{try{await so(b,{hidden:!0});try{Jt({message:`Elemento "${Ee?.name}" marcado como eliminado`,severity:"error"})}catch{}}catch(te){console.error("Failed to mark svg hidden",b,te)}}finally{try{window.dispatchEvent(new Event("svg-elements-updated"))}catch{}le(!1),fe(null)}})()},startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"delete"}),children:"Eliminar"})]})]}),e.jsxs(ht,{children:[e.jsx(Kt,{control:e.jsx(Vt,{checked:z,onChange:b=>he(b.target.checked)}),label:"No guardar en la nube"}),e.jsx(J,{onClick:Ce,color:"error",startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"delete"}),children:"Limpiar"}),e.jsx(J,{onClick:o,color:"warning",startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"close"}),children:"Cancelar"}),e.jsx(J,{onClick:()=>{(async()=>{try{await Promise.resolve(V(z));try{Ce()}catch{}}catch(b){console.error("Error saving SVG element",b)}finally{try{window.dispatchEvent(new CustomEvent("svg-elements-updated"))}catch{}}})()},startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"save"}),variant:"contained",children:"Guardar"})]})]})},ys=()=>{const[i,o]=w.useState(!1),[a,d]=w.useState(""),[x,c]=w.useState("info"),[l,y]=w.useState(3e3);w.useEffect(()=>ls(M=>{d(M.message),c(M.severity||"info"),y(M.duration||3e3),o(!0)}),[]);const p=(S,M)=>{M!=="clickaway"&&o(!1)};return e.jsx(wn,{open:i,autoHideDuration:l,onClose:p,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(xn,{onClose:p,severity:x,sx:{width:"100%"},variant:"filled",children:a})})};let Lt=0;const xr=()=>`node_${Lt++}`,st=20;function Gt(i,o=st){return{x:Math.round(i.x/o)*o,y:Math.round(i.y/o)*o}}function Tt(i,o,a,d=st){const x=y=>o.some(p=>p.id!==a&&p.position.x===y.x&&p.position.y===y.y),c=Gt(i,d);if(!x(c))return c;const l=10;for(let y=1;y<=l;y++){const p=[{x:d,y:0},{x:0,y:d},{x:-d,y:0},{x:0,y:-d},{x:d,y:d},{x:-d,y:d},{x:-d,y:-d},{x:d,y:-d}];for(const S of p){const M={x:c.x+S.x*y,y:c.y+S.y*y};if(!x(M))return M}}return{x:c.x+(Math.random()*4-2)*d,y:c.y+(Math.random()*4-2)*d}}function ws(){const i=N.useRef(null),o=N.useRef(null),[a,d,x]=bn([]),[c,l,y]=vn([]),p=cs();w.useEffect(()=>{if(a.length===0)return;const r=a.filter(j=>j.type==="labelNode");if(r.length===0)return;const f=[...a.filter(j=>j.type!=="labelNode"),...r];f.length===a.length&&f.every((j,C)=>j.id===a[C].id)||d(f)},[a,d]);const[S,M]=w.useState(null),[_,U]=w.useState(null),[T,K]=w.useState(null),[Z,ue]=w.useState(null),[V,ke]=w.useState(null),[je,be]=w.useState(null),[Q,He]=w.useState(null),[X,Pe]=w.useState(localStorage.getItem("dp_username")),[pe,W]=w.useState(""),[z,he]=w.useState(!1),ee=w.useCallback(r=>r?/^[a-zA-Z0-9]{6,}$/.test(r):!1,[]),le=w.useCallback(()=>ee(X)?!0:(W(""),he(!0),!1),[ee,X]),Ee=w.useCallback(async()=>{if(ee(pe))try{localStorage.setItem("dp_username",pe),Pe(pe),he(!1);try{await oo(pe)}catch(r){console.warn("reconcileUserLibrary failed on username save:",r)}try{await yr(pe)}catch(r){console.warn("reconcileUserSchemas failed on username save:",r)}try{window.location.reload()}catch{}}catch(r){console.error("handleUsernameSave failed",r)}},[pe,ee]),fe=w.useCallback(()=>{ee(X)&&he(!1)},[ee,X]),ge=w.useCallback(async()=>{try{const r=["dp_username","username","drawpak-current-schema","drawpak-current-schema-id"];try{for(const n of Object.keys(localStorage))n.startsWith("drawpak:user_library_updated_at:")&&localStorage.removeItem(n)}catch{}for(const n of r)localStorage.removeItem(n);try{await Gn()}catch{console.warn("Failed to clear svg elements during logout")}try{await Kn()}catch{}setTimeout(()=>{try{window.location.reload()}catch{}},50)}catch(r){console.error("Error during logout:",r);try{p.notify({message:"Error cerrando sesión",severity:"error"})}catch{}}},[]);w.useEffect(()=>{ee(X)||he(!0)},[ee,X]);function Ce(r){const n=r.replace("#","").trim();if(n.length===3){const f=parseInt(n[0]+n[0],16),g=parseInt(n[1]+n[1],16),j=parseInt(n[2]+n[2],16);return{r:f,g,b:j}}if(n.length===6){const f=parseInt(n.slice(0,2),16),g=parseInt(n.slice(2,4),16),j=parseInt(n.slice(4,6),16);return{r:f,g,b:j}}return{r:0,g:0,b:0}}function we(r,n){const f={r:255,g:255,b:255,a:1};if(!r)return{...f,a:typeof n=="number"?n:f.a};const g=r.trim();let j={...f};if(g.startsWith("rgba")){const C=g.replace(/rgba\(|\)/g,"").split(",").map(Y=>Y.trim());if(C.length>=4){const Y=Number(C[0])||0,$=Number(C[1])||0,xe=Number(C[2])||0,me=Number(C[3]),ve=Number.isFinite(me)?me:1;j={r:Y,g:$,b:xe,a:ve}}else return{...f,a:typeof n=="number"?n:f.a}}else if(g.startsWith("rgb(")){const C=g.replace(/rgb\(|\)/g,"").split(",").map(Y=>Y.trim());if(C.length>=3)j={r:Number(C[0])||0,g:Number(C[1])||0,b:Number(C[2])||0,a:1};else return{...f,a:typeof n=="number"?n:f.a}}else{const{r:C,g:Y,b:$}=Ce(g);j={r:C,g:Y,b:$,a:1}}return{...j,a:typeof n=="number"?n:j.a}}function ae(r){const n=typeof r.a=="number"?r.a:1;return`rgba(${Math.round(r.r)}, ${Math.round(r.g)}, ${Math.round(r.b)}, ${Number(n.toFixed(3))})`}const[b,te]=w.useState(null);function P(r){if(!r||typeof r!="object")return!1;const n=r,f=n.position;return typeof n.id=="string"&&!!f&&typeof f.x=="number"&&typeof f.y=="number"}function oe(r){if(!r||typeof r!="object")return!1;const n=r;return typeof n.source=="string"&&typeof n.target=="string"&&typeof n.id=="string"}const[re,_e]=w.useState(!1),[F,Oe]=w.useState(null),[Se,Me]=w.useState(!1),[R,se]=w.useState(null),[H,I]=w.useState(!0),[q,D]=w.useState(null),[s,t]=w.useState("portrait"),[h,u]=w.useState(!0),[m,A]=w.useState(null),[k,L]=w.useState([]),[E,ie]=w.useState(-1),[ne,Ae]=w.useState(!1),[We,Fe]=w.useState(!1),[Be,Ze]=w.useState(!1),[Ct,vo]=w.useState([]),[So,ko]=w.useState([]),[Rt,Er]=w.useState(""),[Ne,er]=w.useState(!1),[Re,Ot]=w.useState([]),[Nr,Wt]=w.useState(null),[tr,Ir]=w.useState(""),[Dr,zr]=w.useState("custom"),[Qe,Mr]=w.useState(""),[rr,Tr]=w.useState(""),[jo,or]=w.useState(""),[Co,Lr]=w.useState(!0),_o=w.useMemo(()=>ss,[]),nr=w.useMemo(()=>as,[]),sr=Cr();w.useEffect(()=>{if(!a||!c)return;const r=new Map;for(const g of a)r.set(g.id,g.type||"");let n=!1;const f=c.map(g=>{const j=r.get(g.source)||"",C=r.get(g.target)||"",Y=!!(g.selected&&j==="symbolNode"&&C==="symbolNode"),$=g.style||void 0,xe=nr.style?.stroke,me=$&&$.stroke||xe||"#000000";return Y?me!=="#9e9e9e"?(n=!0,{...g,style:{...g.style||{},stroke:"#9e9e9e"}}):g:$&&$.stroke==="#9e9e9e"?(n=!0,{...g,style:{...g.style||{},stroke:xe||"#000000"}}):g});n&&l(f)},[c,a,l,nr]),w.useEffect(()=>{let r=!0;return(async()=>{if(!Qe){r&&or("");return}try{const g=await Mt(()=>import("./vendor-4Rux7z0p.js").then($=>$.$),__vite__mapDeps([0,1])),C=g.default??g,Y=C.sanitize?String(C.sanitize(Qe,{USE_PROFILES:{svg:!0}})):Qe;r&&or(Y)}catch(n){console.warn("dompurify not available, using raw svg markup for preview",n),r&&or(Qe)}})(),()=>{r=!1}},[Qe]);const[Pr,_t]=w.useState(!1),[$t,Ao]=w.useState([]),[Rr,Eo]=w.useState(""),[Or,No]=w.useState("activos"),[et,ft]=w.useState(""),[tt,At]=w.useState(""),[Ye,Ft]=w.useState(!1),[Io,Do]=w.useState(!1),[Te,rt]=w.useState(null),[Xe,Je]=w.useState(""),[Wr,pt]=w.useState(""),[ar,at]=w.useState(!1),[$r,Fr]=w.useState(!1),[zo,ir]=w.useState(!1),[Mo,mt]=w.useState(!1),[it,yt]=w.useState(null),[ot,wt]=w.useState(null);w.useEffect(()=>{(async()=>{try{await ze();try{await Qt()}catch(n){console.warn("syncSvgsWithBackend fallo (no bloqueante):",n)}try{await Ar()}catch(n){console.warn("syncSchemasWithBackend fallo (no bloqueante):",n)}const r=localStorage.getItem("dp_username")||localStorage.getItem("username")||null;if(r){try{await oo(r)}catch(n){console.warn("reconcileUserLibrary failed:",n)}try{await yr(r)}catch(n){console.warn("reconcileUserSchemas failed:",n)}}}catch(r){console.error("Error inicializando la base de datos:",r)}})()},[]);const Et=N.useCallback(async()=>{try{const r=await bo();vo(r)}catch(r){console.error("Error cargando svg elements",r)}},[]),lr=N.useCallback(async()=>{try{const r=await jr();ko(r)}catch(r){console.error("Error cargando categorías",r)}},[]);w.useEffect(()=>{const r=()=>{Et(),lr()};return window.addEventListener("svg-elements-updated",r),()=>window.removeEventListener("svg-elements-updated",r)},[Et,lr]),w.useEffect(()=>{Be&&Lr(!0)},[Be]);const Ge=N.useCallback(async()=>{try{const r=await xo();Ao(r)}catch(r){console.error("Error cargando esquemas:",r)}},[]),To=N.useCallback(async()=>{try{const r=localStorage.getItem("dp_username")||localStorage.getItem("username")||null;if(!r){try{p.notify({message:"Configura un nombre de usuario antes de sincronizar.",severity:"warning"})}catch{}return}await yr(r),await Ge();try{p.notify({message:"Sincronización de esquemas completada",severity:"success"})}catch{}}catch(r){console.error("Error sincronizando esquemas manualmente:",r);try{p.notify({message:"Error al sincronizar esquemas",severity:"error"})}catch{}}},[Ge,p]),Lo=N.useCallback(async()=>{try{if(Te){await wr(Te,{name:et,description:tt,nodes:JSON.stringify(a),edges:JSON.stringify(c),updated_by:X||localStorage.getItem("dp_username")||"unknown",local:Ye}),Je(et),pt(tt),at(Ye),It(a,c,Te,et),await Ge(),_t(!1);return}if(!et.trim()){try{p.notify({message:"Por favor ingresa un nombre para el esquema",severity:"warning"})}catch{}return}const r=X||localStorage.getItem("dp_username")||"unknown",n=await mo({name:et,description:tt,nodes:JSON.stringify(a),edges:JSON.stringify(c),created_by:r,updated_by:r,local:Ye});rt(n),ft(""),Je(et),pt(tt),at(Ye),It(a,c,n,et),_t(!1),ft(""),At(""),Do(!1),await Ge()}catch(r){console.error("Error guardando esquema:",r);try{p.notify({message:"Error al guardar el esquema",severity:"error"})}catch{}}},[et,tt,a,c,Io,Ge,Te,rt,Ye,X,p]),Po=N.useCallback(async r=>{try{if(!Rt.trim()){try{p.notify({message:"Ingresa un nombre para el elemento SVG",severity:"warning"})}catch{}return}let n=null;try{const $=await Mt(()=>import("./vendor-4Rux7z0p.js").then(xe=>xe.$),__vite__mapDeps([0,1]));n=$.default??$}catch{console.warn("dompurify no disponible, guardando sin sanitizar")}let f=n&&n.sanitize?String(n.sanitize(Qe,{USE_PROFILES:{svg:!0}})):Qe;try{const $=new DOMParser().parseFromString(f||"","image/svg+xml").querySelector("svg");if($){$.querySelectorAll('[data-editor-handle="true"], [data-editor-resize="true"]').forEach(Ke=>Ke.remove());const xe=$.hasAttribute("viewBox")&&$.getAttribute("viewBox")?.trim()!=="",me=$.getAttribute("width"),ve=$.getAttribute("height");if(!xe&&me&&ve){const Ke=parseFloat(me.toString().replace(/[^0-9.-]/g,"")),nt=parseFloat(ve.toString().replace(/[^0-9.-]/g,""));!isNaN(Ke)&&!isNaN(nt)&&Ke>0&&nt>0&&$.setAttribute("viewBox",`0 0 ${Ke} ${nt}`)}$.removeAttribute("width"),$.removeAttribute("height"),f=new XMLSerializer().serializeToString($)}}catch(C){console.warn("Error limpiando SVG antes de guardar:",C)}const g={name:Rt,description:tr,category:Dr,svg:f,handles:rr||""},j=X||localStorage.getItem("dp_username")||"unknown";await Xn({...g,created_by:j,updated_by:j,local:typeof r=="boolean"?r:!1}),Ze(!1),Er(""),Ir(""),zr("custom"),Mr(""),Tr(""),await Et()}catch(n){console.error("Error guardando svg element",n);try{p.notify({message:"Error guardando elemento SVG",severity:"error"})}catch{}}},[Rt,tr,Qe,rr,Et,p]),Ro=N.useCallback(()=>{if(Te){const r=$t.find(n=>n.id===Te);r?(ft(r.name||Xe||""),At(r.description||""),Ft(typeof r.local=="boolean"?r.local:!1)):ft(Xe||"")}else ft(""),At("");_t(!0)},[Te,Xe,$t]),Oo=N.useCallback(async r=>{try{const n=JSON.parse(r.nodes),f=JSON.parse(r.edges),g=Array.isArray(n)?n.filter(P):[],j=Array.isArray(f)?f.filter(oe):[];d(g),l(j),Fe(!1),rt(r.id||null),Je(r.name||""),pt(r.description||""),at(typeof r.local=="boolean"?r.local:!1),It(g,j,r.id||null,r.name);let C=0;for(const Y of g){const $=Y.id?.toString().match(/node_(\d+)/);$&&(C=Math.max(C,Number($[1])))}Lt=C+1}catch(n){console.error("Error cargando esquema:",n);try{p.notify({message:"Error al cargar el esquema",severity:"error"})}catch{}}},[d,l,rt,Je,p]),Wo=N.useCallback(async r=>{try{const n=JSON.parse(r.nodes),f=JSON.parse(r.edges),g=new Map,j=Array.isArray(n)?n:[],C=Array.isArray(f)?f:[],Y=j.map(ve=>{const zt=`node_${Lt++}`;g.set(ve.id,zt);const Ke={x:ve.position.x+100,y:ve.position.y+100},nt=Tt(Ke,a);return{...ve,id:zt,selected:!1,position:nt}}),$=C.filter(ve=>g.has(ve.source)&&g.has(ve.target)).map(ve=>({...ve,id:`edge_${g.get(ve.source)}_${g.get(ve.target)}`,source:g.get(ve.source),target:g.get(ve.target),selected:!1})),xe=[...a,...Y],me=[...c,...$];d(xe),l(me),Fe(!1)}catch(n){console.error("Error importando esquema:",n);try{p.notify({message:"Error al importar el esquema",severity:"error"})}catch{}}},[a,c,d,l,p]),$o=e.jsxs(dt,{open:Mo,onClose:()=>{mt(!1),wt(null),yt(null)},children:[e.jsx(ut,{sx:{textAlign:"center",backgroundColor:"#263238",color:"#fff",fontSize:18,fontWeight:400,padding:"12px 16px"},children:it==="delete"?"Marcar como eliminado":"Restaurar esquema"}),e.jsx(gt,{sx:{mt:2},children:e.jsx(G,{children:it==="delete"?`¿Deseas marcar como eliminado el esquema "${ot?.name}"? Esto lo ocultará en la lista y en el editor.`:`¿Deseas restaurar el esquema "${ot?.name}"?`})}),e.jsxs(ht,{children:[e.jsx(J,{onClick:()=>{mt(!1),wt(null),yt(null)},color:"secondary",children:"Cancelar"}),e.jsx(J,{color:it==="delete"?"error":"success",onClick:()=>{Uo()},children:it==="delete"?"Eliminar":"Restaurar"})]})]}),Fo=N.useCallback((r,n)=>{wt({id:r,name:n}),yt("delete"),mt(!0)},[]),Bo=N.useCallback((r,n)=>{wt({id:r,name:n}),yt("restore"),mt(!0)},[]),Uo=N.useCallback(async()=>{if(!ot||!it){mt(!1),wt(null),yt(null);return}try{const r=X||localStorage.getItem("dp_username")||"unknown";if(it==="delete"){await wr(ot.id,{hidden:!0,updated_by:r});try{p.notify({message:`Esquema "${ot.name}" marcado como eliminado`,severity:"error"})}catch{}}else{await wr(ot.id,{hidden:!1,updated_by:r});try{p.notify({message:`Esquema "${ot.name}" restaurado`,severity:"success"})}catch{}}await Ge()}catch(r){console.error("Error realizando la acción sobre el esquema:",r);try{p.notify({message:"Error procesando la acción sobre el esquema",severity:"error"})}catch{}}finally{mt(!1),wt(null),yt(null)}},[it,ot,X,Ge,p]),qo=N.useCallback(async(r,n)=>{const f=prompt(`Ingresa el nombre para la copia de "${n}":`,`${n} (copia)`);if(f&&f.trim())try{await Yn(r,f.trim()),await Ge()}catch(g){console.error("Error duplicando esquema:",g);try{p.notify({message:"Error al duplicar el esquema",severity:"error"})}catch{}}},[Ge,p]),Bt="drawpak-current-schema",Nt="drawpak-current-schema-id",cr="drawpak-current-schema-name",dr="drawpak-current-schema-description",Ut="drawpak-current-schema-local",It=N.useCallback((r,n,f=null,g="")=>{try{let j=null,C=null;try{if(i.current){const $=i.current.getBoundingClientRect();j=Math.round($.width),C=Math.round($.height)}}catch{}const Y={nodes:r,edges:n,timestamp:Date.now(),currentSchemaId:f||Te,currentSchemaName:g||Xe||"",currentSchemaDescription:tt||Wr||"",currentSchemaLocal:typeof Ye=="boolean"?Ye:ar,canvasWidth:j,canvasHeight:C};localStorage.setItem(Bt,JSON.stringify(Y)),f!==null?(localStorage.setItem(Nt,String(f)),localStorage.setItem(cr,String(g)),localStorage.setItem(dr,String(tt||"")),localStorage.setItem(Ut,String(Ye||!1))):(localStorage.removeItem(Nt),localStorage.removeItem(cr),localStorage.removeItem(dr),localStorage.removeItem(Ut)),A(new Date)}catch(j){console.error("Error guardando en localStorage:",j)}},[Wr,Te,ar,Xe,tt,Ye]),Br=N.useCallback(()=>{try{const r=localStorage.getItem(Bt),n=localStorage.getItem(Nt),f=localStorage.getItem(cr),g=localStorage.getItem(dr),j=localStorage.getItem(Ut);if(r){const C=JSON.parse(r);n?(rt(n),Je(f||""),pt(g||""),at(j==="false")):C.currentSchemaId&&(rt(C.currentSchemaId),Je(C.currentSchemaName||""),pt(C.currentSchemaDescription||""),at(typeof C.currentSchemaLocal=="boolean"?C.currentSchemaLocal:!1)),f&&Je(f),g&&At(g),j&&Ft(j==="true");const Y=typeof C.currentSchemaLocal=="boolean"?C.currentSchemaLocal:j?j==="true":!1;return{nodes:C.nodes||[],edges:C.edges||[],currentSchemaId:n||C.currentSchemaId||null,currentSchemaName:C.currentSchemaName||"",currentSchemaDescription:C.currentSchemaDescription||"",currentSchemaLocal:Y,canvasWidth:typeof C.canvasWidth=="number"?C.canvasWidth:null,canvasHeight:typeof C.canvasHeight=="number"?C.canvasHeight:null}}}catch(r){console.error("Error cargando desde localStorage:",r)}return{nodes:[],edges:[],currentSchemaId:null,currentSchemaName:"",currentSchemaLocal:!1}},[]);w.useEffect(()=>{const{nodes:r,edges:n,currentSchemaId:f,currentSchemaName:g,currentSchemaDescription:j,currentSchemaLocal:C}=Br();if(r.length>0||n.length>0){d(r),l(n),f&&rt(f),g&&Je(g),j&&pt(j),typeof C=="boolean"&&at(C);let Y=0;for(const $ of r){const xe=$.id?.toString().match(/node_(\d+)/);xe&&(Y=Math.max(Y,Number(xe[1])))}Lt=Y+1,setTimeout(()=>{const $={nodes:JSON.parse(JSON.stringify(r)),edges:JSON.parse(JSON.stringify(n))};L([$]),ie(0),xt.current=JSON.stringify(r),bt.current=JSON.stringify(n)},100)}else L([]),ie(-1)},[Br,d,l]),w.useEffect(()=>{if(a.length>0||c.length>0)It(a,c,Te,Xe);else try{localStorage.removeItem(Bt),localStorage.removeItem(Nt)}catch(r){console.error("Error limpiando localStorage:",r)}},[a,c,It,Te,Xe]);const Ur=N.useCallback((r,n)=>{L(f=>{const g={nodes:JSON.parse(JSON.stringify(r)),edges:JSON.parse(JSON.stringify(n))};if(f.length>0){const Y=f[f.length-1];if(JSON.stringify(Y.nodes)===JSON.stringify(g.nodes)&&JSON.stringify(Y.edges)===JSON.stringify(g.edges))return f}const j=E,C=f.slice(0,j+1);return C.push(g),C.length>50?(C.shift(),ie(Y=>Math.max(0,Y-1)),C):(ie(C.length-1),C)})},[E]),ur=N.useCallback(()=>{if(E>0){Ae(!0);const r=k[E-1];Ue.current&&(clearTimeout(Ue.current),Ue.current=null),d(r.nodes),l(r.edges),ie(E-1),xt.current=JSON.stringify(r.nodes),bt.current=JSON.stringify(r.edges),setTimeout(()=>Ae(!1),50)}},[E,k,d,l]),gr=N.useCallback(()=>{if(E<k.length-1){Ae(!0);const r=k[E+1];Ue.current&&(clearTimeout(Ue.current),Ue.current=null),d(r.nodes),l(r.edges),ie(E+1),xt.current=JSON.stringify(r.nodes),bt.current=JSON.stringify(r.edges),setTimeout(()=>Ae(!1),50)}},[E,k,d,l]),xt=w.useRef(""),bt=w.useRef(""),Ue=w.useRef(null);w.useEffect(()=>{if(ne)return;const r=JSON.stringify(a),n=JSON.stringify(c);return(r!==xt.current||n!==bt.current)&&(Ue.current&&clearTimeout(Ue.current),Ue.current=setTimeout(()=>{ne||((a.length>0||c.length>0||xt.current!==""||bt.current!=="")&&Ur(a,c),xt.current=r,bt.current=n)},100)),()=>{Ue.current&&clearTimeout(Ue.current)}},[a,c,Ur,ne]),w.useEffect(()=>{const r=n=>{Be||(n.ctrlKey||n.metaKey)&&(n.key==="z"&&!n.shiftKey?(n.preventDefault(),ur()):(n.key==="y"||n.key==="z"&&n.shiftKey)&&(n.preventDefault(),gr()))};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[ur,gr]);const Ho=N.useCallback(r=>{const n={...r,type:"smoothstep",style:{strokeWidth:2,stroke:"#000000"}};l(f=>Sn(n,f))},[l]),qr=N.useCallback(()=>{let r=[];d(n=>(r=n.filter(f=>f.selected).map(f=>f.id),n.filter(f=>!f.selected))),l(n=>n.filter(f=>!f.selected&&!r.includes(f.source)&&!r.includes(f.target)))},[d,l]),qt=N.useCallback(()=>{d([]),l([]),Lt=0,rt(null),Je("");try{at(!1),Ft(!1),localStorage.removeItem(Ut)}catch{}try{localStorage.removeItem(Bt),localStorage.removeItem(Nt)}catch(r){console.error("Error limpiando localStorage:",r)}L([]),ie(-1)},[d,l,rt,Je]),Yo=N.useCallback(()=>{$r||(a.length>0||c.length>0?ir(!0):qt())},[a.length,c.length,Te,Xe,qt,$r]),Xo=N.useCallback(()=>{ir(!1),Fr(!1),qt()},[qt]),Hr=N.useCallback(()=>{ir(!1),Fr(!1)},[]),Yr=N.useCallback(()=>{const r=a.filter(g=>g.selected),n=r.map(g=>g.id),f=c.filter(g=>n.includes(g.source)&&n.includes(g.target));r.length>0&&te({nodes:r,edges:f})},[a,c,te]),Xr=N.useCallback(()=>{if(!b||b.nodes.length===0)return;const r={},n=b.nodes.map(g=>{const j=xr();r[g.id]=j;const C={x:g.position.x+st*2,y:g.position.y+st*2},Y=Tt(C,a);return{...g,id:j,position:Y,selected:!0}}),f=b.edges.map(g=>({...g,id:`edge_${Date.now()}_${Math.random()}`,source:r[g.source],target:r[g.target]}));d(g=>g.map(j=>({...j,selected:!1})).concat(n)),l(g=>g.concat(f))},[b,d,l,a]);w.useEffect(()=>{const r="polygon-cursor-style";let n=document.getElementById(r);return n||(n=document.createElement("style"),n.id=r,document.head.appendChild(n)),Ne?n.textContent=`
        .polygon-drawing-mode .react-flow__pane,
        .polygon-drawing-mode .react-flow__container,
        .polygon-drawing-mode .react-flow__renderer,
        .polygon-drawing-mode {
          cursor: crosshair !important;
        }
        /* Allow clicking through nodes/edges while drawing polygon */
        .polygon-drawing-mode .react-flow__node,
        .polygon-drawing-mode .react-flow__edge {
          pointer-events: none !important;
        }
      `:n.textContent="",()=>{n&&!Ne&&(n.textContent="")}},[Ne,ee,X,le]),w.useEffect(()=>{},[Pr]);const Jo=N.useCallback(()=>{le()&&(er(r=>!r),Ne&&(Ot([]),Wt(null)))},[Ne,le]),Go=N.useCallback(r=>{if(!Ne||!i.current||!o.current)return;if(!ee(X)){he(!0);return}const n=i.current.getBoundingClientRect(),f=r.clientX-n.left,g=r.clientY-n.top,j=o.current.project({x:f,y:g});if(j){const C=Gt(j,st);Ot(Y=>[...Y,C])}},[Ne]),Jr=N.useCallback(()=>{if(Re.length>=2){const r=`polygon_${Date.now()}`,n=Math.min(...Re.map(me=>me.x)),f=Math.min(...Re.map(me=>me.y)),g=10,j={x:n-g,y:f-g},C=Gt({x:Math.round(j.x),y:Math.round(j.y)},st),Y=C.x,$=C.y,xe={id:r,type:"polygonNode",position:{x:Y,y:$},data:{points:Re,strokeColor:"#2196F3",strokeWidth:2,strokeDasharray:"5,5",fillColor:"#2196F3",fillOpacity:.1},selectable:!0,deletable:!0};d(me=>[xe,...me])}Ot([]),Wt(null),er(!1)},[Re,d]),Gr=N.useCallback(()=>{Ot([]),er(!1),Wt(null)},[]),Ko=N.useCallback(r=>{if(!Ne||!i.current||!o.current)return;const n=i.current.getBoundingClientRect(),f=o.current.project({x:r.clientX-n.left,y:r.clientY-n.top});if(f){const g=Gt(f,st);Wt(g)}},[Ne]);N.useEffect(()=>{const r=n=>{if(Be)return;const f=document.activeElement,g=f&&(f.tagName==="INPUT"||f.tagName==="TEXTAREA"||f.isContentEditable);if(!g&&(n.key==="Delete"||n.key==="Backspace")){n.preventDefault(),qr();return}if(!g&&n.ctrlKey&&n.key==="c"){n.preventDefault(),Yr();return}if(!g&&n.ctrlKey&&n.key==="v"){n.preventDefault(),Xr();return}if(Ne){if(n.key==="Enter"){n.preventDefault(),Jr();return}if(n.key==="Escape"){n.preventDefault(),Gr();return}}};return window.addEventListener("keydown",r,!0),()=>window.removeEventListener("keydown",r,!0)},[qr,Yr,Xr,Ne,Jr,Gr]);const Vo=(r,n,f)=>{r.dataTransfer.setData("application/reactflow",n),f&&r.dataTransfer.setData("application/svgelement",JSON.stringify(f)),r.dataTransfer.effectAllowed="move"},Zo=N.useCallback(r=>{if(r.preventDefault(),!i.current||!le())return;const n=i.current.getBoundingClientRect(),f=r.dataTransfer.getData("application/reactflow");if(!f)return;const g=r.dataTransfer.getData("application/svgelement");let j=null;try{g&&(j=JSON.parse(g))}catch(me){console.warn("Error parsing SVG element data:",me)}const C={x:r.clientX-n.left,y:r.clientY-n.top},Y=o.current&&typeof o.current.project=="function"?o.current.project(C):C,$=Tt(Y,a),xe={id:xr(),position:$,type:"symbolNode",data:j?{symbolKey:f,label:j.name,svg:j.svg,handles:j.handles,isDynamicSvg:!0,primaryColor:"rgba(0,0,0,1)",backgroundColor:"rgba(255,255,255,0)"}:{symbolKey:f,label:f,isDynamicSvg:!1,primaryColor:"rgba(0,0,0,1)",backgroundColor:"rgba(255,255,255,0)"}};d(me=>me.concat(xe))},[d,a,le]),Qo=N.useCallback(r=>{r.preventDefault(),r.dataTransfer.dropEffect="move"},[]),en=N.useCallback(r=>{if(!re||!i.current)return;r.preventDefault(),r.stopPropagation();const n=i.current.getBoundingClientRect(),f=r.clientX-n.left,g=r.clientY-n.top;se({x:f,y:g}),Me(!0),Oe(null)},[re]),tn=N.useCallback(r=>{if(!re||!Se||!R||!i.current)return;r.preventDefault(),r.stopPropagation();const n=i.current.getBoundingClientRect(),f=r.clientX-n.left,g=r.clientY-n.top,j=Math.min(R.x,f),C=Math.min(R.y,g),Y=Math.abs(f-R.x),$=Math.abs(g-R.y);Oe({x:j,y:C,width:Y,height:$})},[re,Se,R]),rn=N.useCallback(r=>{!re||!Se||(r.preventDefault(),r.stopPropagation(),Me(!1),se(null))},[re,Se]),Kr=N.useCallback((r="png")=>{D(r),_e(!0),Oe(null),I(!0)},[]),Dt=N.useCallback(()=>{_e(!1),Oe(null),Me(!1),se(null),I(!0),D(null)},[]),on=N.useCallback(async()=>{if(!F||!i.current){try{p.notify({message:"Primero selecciona un área para exportar",severity:"warning"})}catch{}return}try{u(!1),I(!1),await new Promise($=>requestAnimationFrame($));let r=null;try{const{toPng:$}=await Mt(async()=>{const{toPng:xe}=await import("./vendor-4Rux7z0p.js").then(me=>me.a0);return{toPng:xe}},__vite__mapDeps([0,1]));r=await $(i.current,{cacheBust:!0,backgroundColor:"#ffffff"})}finally{u(!0),I(!0)}if(!r)return;const n=document.createElement("canvas"),f=n.getContext("2d");if(!f)return;const g=window.devicePixelRatio||1;n.width=F.width*g,n.height=F.height*g,n.style.width=F.width+"px",n.style.height=F.height+"px",f.setTransform(g,0,0,g,0,0),f.fillStyle="#ffffff",f.fillRect(0,0,F.width,F.height);const j=new Image;await new Promise(($,xe)=>{j.onload=()=>$(),j.onerror=xe,j.src=r}),f.drawImage(j,F.x,F.y,F.width,F.height,0,0,F.width,F.height);const C=n.toDataURL("image/png"),Y=document.createElement("a");Y.href=C,Y.download="area_selected.png",Y.click(),Dt()}catch(r){console.error("Error exporting selected area:",r);try{p.notify({message:"Error al exportar el área seleccionada",severity:"error"})}catch{}}},[F,Dt,p]),nn=N.useCallback(async()=>{if(!F||!i.current){try{p.notify({message:"Primero selecciona un área para exportar",severity:"warning"})}catch{}return}try{u(!1),I(!1),await new Promise(qe=>requestAnimationFrame(qe));let r=null;try{const{toPng:qe}=await Mt(async()=>{const{toPng:vt}=await import("./vendor-4Rux7z0p.js").then(fr=>fr.a0);return{toPng:vt}},__vite__mapDeps([0,1]));r=await qe(i.current,{cacheBust:!0,backgroundColor:"#ffffff"})}finally{u(!0),I(!0)}if(!r)return;const n=document.createElement("canvas"),f=n.getContext("2d");if(!f)return;const g=window.devicePixelRatio||1;n.width=F.width*g,n.height=F.height*g,n.style.width=F.width+"px",n.style.height=F.height+"px",f.setTransform(g,0,0,g,0,0),f.fillStyle="#ffffff",f.fillRect(0,0,F.width,F.height);const j=new Image;await new Promise((qe,vt)=>{j.onload=()=>qe(),j.onerror=vt,j.src=r}),f.drawImage(j,F.x,F.y,F.width,F.height,0,0,F.width,F.height);const C=n.toDataURL("image/png"),Y=s==="landscape"?"landscape":"portrait",$=210,xe=297,me=Y==="landscape"?xe:$,ve=Y==="landscape"?$:xe,zt=96,Ke=qe=>qe*25.4/zt,nt=Ke(n.width/(window.devicePixelRatio||1)),Vr=Ke(n.height/(window.devicePixelRatio||1));let hr=me,Ht=Vr*me/nt;Ht>ve&&(Ht=ve,hr=nt*ve/Vr);const an=(me-hr)/2,ln=(ve-Ht)/2;try{const[{default:qe}]=await Promise.all([Mt(()=>import("./vendor-4Rux7z0p.js").then(un=>un.a1),__vite__mapDeps([0,1]))]),vt=new qe({unit:"mm",format:"a4",orientation:Y});vt.addImage(C,"PNG",an,ln,hr,Ht);const fr=vt.output("arraybuffer"),cn=new Uint8Array(fr),dn=new Blob([cn],{type:"application/pdf"}),Zr=URL.createObjectURL(dn),pr=document.createElement("a");pr.href=Zr,pr.download="diagram_a4.pdf",pr.click(),URL.revokeObjectURL(Zr)}catch(qe){console.error("Failed to load jsPDF dynamically",qe);try{p.notify({message:"No se pudo generar el PDF: librería faltante",severity:"error"})}catch{}}Dt()}catch(r){console.error("Error exporting selected area to PDF:",r);try{p.notify({message:"Error al exportar el área seleccionada a PDF",severity:"error"})}catch{}}},[F,s,Dt,p]),sn=N.useCallback((r,n)=>{const f=Tt(n.position,a,n.id);f.x=Math.round(f.x),f.y=Math.round(f.y),d(g=>g.map(j=>j.id===n.id?{...j,position:f}:j)),l(g=>[...g])},[d,l,a]),ce=a.find(r=>r.selected),De=r=>{if(ce){if(r.invertHandles!==void 0){const n=ce.id;l(f=>f.filter(g=>g.source!==n&&g.target!==n))}d(n=>n.map(f=>f.id===ce.id?{...f,data:{...f.data,...r}}:f))}};return e.jsxs(v,{sx:{height:"100vh",display:"flex",flexDirection:"column",position:"relative",overflow:"hidden"},children:[e.jsx(kn,{position:"static",children:e.jsxs(jn,{variant:"dense",children:[e.jsx(v,{component:"img",src:"/logo.svg",alt:"DrawPaK logo",sx:{width:36,height:36,mr:1}}),e.jsx(Ie,{color:"inherit",onClick:Yo,title:"Nuevo esquema",children:e.jsx("span",{className:"material-symbols-rounded",children:"add"})}),e.jsx(Ie,{color:"inherit",onClick:ur,disabled:E<=0,title:`Deshacer (Ctrl+Z) - ${E}/${k.length}`,children:e.jsx("span",{className:"material-symbols-rounded",children:"undo"})}),e.jsx(Ie,{color:"inherit",onClick:gr,disabled:E>=k.length-1,title:`Rehacer (Ctrl+Y) - ${E}/${k.length}`,children:e.jsx("span",{className:"material-symbols-rounded",children:"redo"})}),e.jsx(Ie,{color:"inherit",onClick:Ro,title:Te?"Actualizar esquema":"Guardar esquema",children:e.jsx("span",{className:"material-symbols-rounded",children:"save"})}),e.jsx(Ie,{color:"inherit",onClick:()=>{Ge(),Fe(!0)},title:"Cargar esquema",children:e.jsx("span",{className:"material-symbols-rounded",children:"folder_open"})}),e.jsxs(G,{variant:"h6",sx:{flexGrow:1,textAlign:"center"},children:["Editor de esquemas",Xe?`: ${Xe}`:": Nuevo",m&&e.jsxs(G,{variant:"caption",display:"block",sx:{fontSize:"0.6rem",opacity:.7},children:["Guardado automáticamente: ",m.toLocaleTimeString()]})]}),e.jsx(Ie,{color:"inherit",onClick:()=>{Et(),lr(),Ze(!0)},title:"Elementos SVG",children:e.jsx("span",{className:"material-symbols-rounded",children:"edit"})}),e.jsx(Ie,{color:"inherit",onClick:()=>{const r=o.current?o.current.project({x:(i.current?.clientWidth||800)/2,y:(i.current?.clientHeight||600)/2}):{x:100,y:100},n=Tt(r,a),f={id:xr(),position:n,type:"labelNode",data:{label:"Nueva etiqueta",fontSize:14,color:"#000000",backgroundColor:"rgba(255,255,255,0)",borderColor:"#000000",borderWidth:0}};d(g=>g.concat(f))},title:"Añadir etiqueta",children:e.jsx("span",{className:"material-symbols-rounded",children:"label"})}),e.jsx(Ie,{color:"inherit",onClick:Jo,title:Ne?"Salir del modo polígono (Esc para cancelar)":"Dibujar polígono (clic para puntos, Enter para terminar)",sx:{backgroundColor:Ne?"rgba(255,255,255,0.2)":"transparent","&:hover":{backgroundColor:Ne?"rgba(255,255,255,0.3)":"rgba(255,255,255,0.1)"}},children:e.jsx("span",{className:"material-symbols-rounded",children:"polyline"})}),re?e.jsxs(e.Fragment,{children:[e.jsx(Ie,{color:"inherit",onClick:()=>{(async()=>q==="pdf"?await nn():await on())()},title:"Exportar área seleccionada",disabled:!F,children:e.jsx("span",{className:"material-symbols-rounded",children:"check"})}),e.jsx(Ie,{color:"inherit",onClick:Dt,title:"Cancelar selección",children:e.jsx("span",{className:"material-symbols-rounded",children:"close"})})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ie,{color:"inherit",onClick:()=>Kr("png"),title:"Seleccionar área para exportar PNG",children:e.jsx("span",{className:"material-symbols-rounded",children:"crop_free"})}),e.jsx(Ie,{color:"inherit",onClick:()=>Kr("pdf"),title:"Seleccionar área para exportar PDF",children:e.jsx("span",{className:"material-symbols-rounded",children:"picture_as_pdf"})})]}),e.jsx(G,{variant:"subtitle2",sx:{marginLeft:2,marginRight:1},children:X?`Usuario: ${X}`:""}),e.jsx(Ie,{color:"inherit",onClick:()=>{ge()},title:"Cerrar sesión (borrar datos locales)",children:e.jsx("span",{className:"material-symbols-rounded",children:"logout"})})]})}),e.jsxs(v,{ref:i,sx:{flex:1,position:"relative",cursor:re||Ne?"crosshair":"default",overflow:"auto"},onMouseDown:re?en:void 0,onMouseMove:re?tn:void 0,onMouseUp:re?rn:void 0,children:[e.jsx(Cn,{children:e.jsxs(_n,{style:{width:"100%",height:"100%"},className:Ne?"polygon-drawing-mode":"",nodes:a,edges:c,onNodesChange:x,onEdgesChange:y,onConnect:Ho,onNodeDragStop:sn,onPaneClick:Go,onPaneMouseMove:Ko,snapToGrid:!0,snapGrid:is,connectionLineType:An.SmoothStep,defaultEdgeOptions:nr,nodeTypes:_o,onInit:r=>{o.current=r},onDrop:Zo,onDragOver:Qo,fitView:!0,attributionPosition:"bottom-left",connectOnClick:!1,elementsSelectable:!re&&!Ne,panOnDrag:!re&&!Ne,zoomOnScroll:!re,zoomOnPinch:!re,zoomOnDoubleClick:!re,children:[e.jsx(En,{}),e.jsx(Nn,{}),h&&e.jsx(In,{gap:st})]})}),re&&F&&H&&e.jsx(v,{sx:{position:"absolute",left:F.x,top:F.y,width:F.width,height:F.height,border:"1px dashed #2196f3",backgroundColor:"rgba(33, 150, 243, 0.1)",pointerEvents:"none",zIndex:1e3}}),re&&H&&e.jsxs(v,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",background:"rgba(0, 0, 0, 0.6)",color:"white",p:2,borderRadius:1,textAlign:"center",zIndex:1001,pointerEvents:"none"},children:[e.jsx(G,{variant:"h6",sx:{mb:1},children:"Seleccionar área para exportar"}),e.jsx(G,{variant:"body2",sx:{mb:1},children:"Arrastra para dibujar un rectángulo sobre el área que quieres exportar"}),q==="pdf"&&e.jsxs(v,{sx:{display:"flex",gap:1,justifyContent:"center",pointerEvents:"auto"},children:[e.jsx(J,{variant:s==="portrait"?"contained":"outlined",size:"small",sx:{color:"white"},onClick:()=>t("portrait"),children:"Vertical"}),e.jsx(J,{variant:s==="landscape"?"contained":"outlined",size:"small",sx:{color:"white"},onClick:()=>t("landscape"),children:"Horizontal"})]})]}),Ne&&Re.length>0&&i.current&&e.jsx(v,{sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:1e3},children:e.jsxs("svg",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",overflow:"visible"},children:[Re.map((r,n)=>{if(n===0)return null;const f=Re[n-1],g=i.current?.getBoundingClientRect();if(!g||!o.current)return null;const j=o.current.flowToScreenPosition(f),C=o.current.flowToScreenPosition(r);return e.jsx("line",{x1:j.x-g.left,y1:j.y-g.top,x2:C.x-g.left,y2:C.y-g.top,stroke:"#2196F3",strokeWidth:"2",strokeDasharray:"5,5"},`line-${n}`)}),Re.length>0&&Nr&&o.current&&(()=>{const r=Re[Re.length-1],n=i.current?.getBoundingClientRect();if(!n)return null;const f=o.current.flowToScreenPosition(r),g=o.current.flowToScreenPosition(Nr);return e.jsx("line",{x1:f.x-n.left,y1:f.y-n.top,x2:g.x-n.left,y2:g.y-n.top,stroke:"#2196F3",strokeWidth:"2",strokeDasharray:"3,3",opacity:"0.7"})})(),Re.map((r,n)=>{const f=i.current?.getBoundingClientRect();if(!f||!o.current)return null;const g=o.current.flowToScreenPosition(r);return e.jsx("circle",{cx:g.x-f.left,cy:g.y-f.top,r:"4",fill:"#2196F3",stroke:"white",strokeWidth:"2"},`point-${n}`)})]})}),Ne&&e.jsxs(v,{sx:{position:"absolute",top:80,left:"50%",transform:"translateX(-50%)",background:"rgba(33, 150, 243, 0.2)",color:"black",p:2,borderRadius:1,textAlign:"center",zIndex:1001,pointerEvents:"none"},children:[e.jsx(G,{variant:"body2",sx:{mb:1},children:e.jsx("strong",{children:"Modo Polígono Activo"})}),e.jsx(G,{variant:"caption",display:"block",children:"• Clic para añadir puntos"}),e.jsx(G,{variant:"caption",display:"block",children:"• Enter para terminar polígono (min. 2 puntos)"}),e.jsx(G,{variant:"caption",display:"block",children:"• Escape para cancelar"}),Re.length>0&&e.jsxs(G,{variant:"caption",display:"block",sx:{mt:1,fontWeight:"bold"},children:["Puntos: ",Re.length]})]})]}),e.jsx(es,{onDragStart:Vo}),ce?e.jsxs(v,{sx:{position:"absolute",right:12,top:72,padding:2,backgroundColor:"rgba(0, 0, 0, 0.6)",border:"1px solid #ddd",borderRadius:6,zIndex:1300},children:[e.jsx(G,{variant:"h6",sx:{fontSize:14,fontWeight:600,marginBottom:2,textAlign:"center",color:"white"},children:"Edición"}),ce.type==="labelNode"?e.jsxs(v,{sx:{display:"flex",flexDirection:"column",gap:1,color:"white",width:260},children:[e.jsxs(v,{sx:{display:"flex",gap:1,mb:1},children:[e.jsx(J,{variant:"contained",size:"small",fullWidth:!0,startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"rotate_left"}),onClick:()=>De({rotation:(ce.data?.rotation??0)-90}),children:"90°"}),e.jsx(J,{variant:"contained",size:"small",fullWidth:!0,startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"rotate_right"}),onClick:()=>De({rotation:(ce.data?.rotation??0)+90}),children:"90°"})]}),e.jsx(de,{size:"small",label:"Texto",value:ce.data?.label??"",onChange:r=>De({label:r.target.value}),sx:{borderColor:"white","& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"white"},"&:hover fieldset":{borderColor:"white"},"&.Mui-focused fieldset":{borderColor:"white"}},"& .MuiInputLabel-root":{color:"white"},"& .MuiInputBase-input":{color:"white"}}}),e.jsx(de,{size:"small",type:"number",label:"Tamaño de fuente",value:ce.data?.fontSize??14,onChange:r=>{const n=Number(r.target.value);isNaN(n)||De({fontSize:n})},sx:{borderColor:"white","& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"white"},"&:hover fieldset":{borderColor:"white"},"&.Mui-focused fieldset":{borderColor:"white"}},"& .MuiInputLabel-root":{color:"white"},"& .MuiInputBase-input":{color:"white"}}}),e.jsxs(v,{sx:{display:"flex",gap:1,alignItems:"center",justifyContent:"space-evenly"},children:[e.jsxs(v,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(J,{variant:"outlined",size:"small",onClick:r=>K(r.currentTarget),sx:{minWidth:32,width:32,height:32,padding:0,backgroundColor:ce.data?.backgroundColor??"transparent",border:"1px solid rgba(0,0,0,0.2)"}}),e.jsx(G,{sx:{color:"white",fontSize:12},children:"Relleno"}),e.jsx(lt,{open:!!T,anchorEl:T,onClose:()=>K(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},children:e.jsx(v,{sx:{p:1},children:e.jsx(ct,{color:we(ce.data?.backgroundColor??"rgba(255,255,255,0)"),onChange:r=>De({backgroundColor:ae(r)})})})})]}),e.jsxs(v,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(J,{variant:"outlined",size:"small",onClick:r=>ue(r.currentTarget),sx:{minWidth:32,width:32,height:32,padding:0,backgroundColor:ce.data?.borderColor??"transparent",border:"1px solid rgba(0,0,0,0.2)"}}),e.jsx(G,{sx:{color:"white",fontSize:12},children:"Color línea"}),e.jsx(lt,{open:!!Z,anchorEl:Z,onClose:()=>ue(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},children:e.jsx(v,{sx:{p:1},children:e.jsx(ct,{color:we(ce.data?.borderColor??"#000000"),onChange:r=>De({borderColor:ae(r)})})})})]})]}),e.jsxs(v,{sx:{display:"flex",gap:1,alignItems:"center",justifyContent:"space-evenly"},children:[e.jsxs(v,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(J,{variant:"outlined",size:"small",onClick:r=>ke(r.currentTarget),sx:{minWidth:32,width:32,height:32,padding:0,backgroundColor:ce.data?.color??"transparent",border:"1px solid rgba(0,0,0,0.2)"}}),e.jsx(G,{sx:{color:"white",fontSize:12},children:"Color texto"}),e.jsx(lt,{open:!!V,anchorEl:V,onClose:()=>ke(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},children:e.jsx(v,{sx:{p:1},children:e.jsx(ct,{color:we(ce.data?.color??"#000000"),onChange:r=>De({color:ae(r)})})})})]}),e.jsx(de,{size:"small",type:"number",label:"Ancho línea",value:ce.data?.borderWidth??0,onChange:r=>{const n=Number(r.target.value);isNaN(n)||De({borderWidth:n})},sx:{width:100,borderColor:"white","& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"white"},"&:hover fieldset":{borderColor:"white"},"&.Mui-focused fieldset":{borderColor:"white"}},"& .MuiInputLabel-root":{color:"white"},"& .MuiInputBase-input":{color:"white"}}})]})]}):ce.type==="polygonNode"?e.jsxs(v,{sx:{display:"flex",flexDirection:"column",gap:1,color:"white",width:260},children:[e.jsx(de,{size:"small",type:"number",label:"Ancho línea",value:ce.data?.strokeWidth??2,onChange:r=>{const n=Number(r.target.value);isNaN(n)||De({strokeWidth:n})},sx:{width:"100%",borderColor:"white","& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"white"},"&:hover fieldset":{borderColor:"white"},"&.Mui-focused fieldset":{borderColor:"white"}},"& .MuiInputLabel-root":{color:"white"},"& .MuiInputBase-input":{color:"white"}}}),e.jsxs(v,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(J,{variant:"outlined",size:"small",onClick:r=>be(r.currentTarget),sx:{minWidth:32,width:32,height:32,padding:0,backgroundColor:ce.data?.strokeColor??"#2196F3",border:"1px solid rgba(0,0,0,0.2)"}}),e.jsx(G,{sx:{color:"white",fontSize:12},children:"Color línea"}),e.jsx(lt,{open:!!je,anchorEl:je,onClose:()=>be(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},children:e.jsx(v,{sx:{p:1},children:e.jsx(ct,{color:we(ce.data?.strokeColor??"#2196F3"),onChange:r=>De({strokeColor:ae(r)})})})})]}),e.jsxs(v,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(J,{variant:"outlined",size:"small",onClick:r=>He(r.currentTarget),sx:{minWidth:32,width:32,height:32,padding:0,backgroundColor:ce.data?.fillColor??"rgba(33,150,243,0.1)",border:"1px solid rgba(0,0,0,0.2)"}}),e.jsx(G,{sx:{color:"white",fontSize:12},children:"Relleno"}),e.jsx(lt,{open:!!Q,anchorEl:Q,onClose:()=>He(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},children:e.jsx(v,{sx:{p:1},children:e.jsx(ct,{color:we(ce.data?.fillColor??"#2196F3",ce.data?.fillOpacity),onChange:r=>{const{r:n,g:f,b:g,a:j}=r;De({fillColor:`rgb(${Math.round(n)}, ${Math.round(f)}, ${Math.round(g)})`,fillOpacity:typeof j=="number"?j:1})}})})})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(v,{sx:{display:"flex",gap:1,mb:1},children:[e.jsx(J,{variant:"contained",size:"small",fullWidth:!0,startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"rotate_left"}),onClick:()=>De({rotation:(ce.data?.rotation??0)-90}),children:"90°"}),e.jsx(J,{variant:"contained",size:"small",fullWidth:!0,startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"rotate_right"}),onClick:()=>De({rotation:(ce.data?.rotation??0)+90}),children:"90°"})]}),e.jsxs(v,{sx:{display:"flex",gap:1,mb:1,width:220},children:[e.jsx(J,{variant:"contained",size:"small",fullWidth:!0,startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"flip"}),onClick:()=>De({flipX:!(ce.data?.flipX??!1)}),children:"Flip X"}),e.jsx(J,{variant:"contained",size:"small",fullWidth:!0,startIcon:e.jsx("span",{className:"material-symbols-rounded",style:{transform:"rotate(90deg)"},children:"flip"}),onClick:()=>De({flipY:!(ce.data?.flipY??!1)}),children:"Flip Y"})]}),e.jsxs(v,{sx:{display:"flex",flexDirection:"column",gap:1,mb:1,color:"white"},children:[e.jsx(de,{type:"number",size:"small",slotProps:{htmlInput:{min:.5,max:2,step:.05}},sx:{borderColor:"white","& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"white"},"&:hover fieldset":{borderColor:"white"},"&.Mui-focused fieldset":{borderColor:"white"}},"& .MuiInputLabel-root":{color:"white"},"& .MuiInputBase-input":{color:"white"}},fullWidth:!0,label:"Escala",value:ce.data?.scale??1,onChange:r=>{const n=Number(r.target.value);isNaN(n)||De({scale:n})}}),e.jsxs(v,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(J,{variant:"outlined",size:"small",onClick:r=>M(r.currentTarget),sx:{minWidth:32,width:32,height:32,padding:0,backgroundColor:ce.data?.backgroundColor??"rgba(255, 255, 255, 0)",border:"1px solid rgba(0,0,0,0.2)"}}),e.jsx(G,{sx:{color:"white",fontSize:12},children:"Relleno"}),e.jsx(lt,{open:!!S,anchorEl:S,onClose:()=>M(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},children:e.jsx(v,{sx:{p:1},children:e.jsx(ct,{color:we(ce.data?.backgroundColor),onChange:r=>De({backgroundColor:ae(r)})})})}),e.jsx(J,{variant:"outlined",size:"small",onClick:r=>U(r.currentTarget),sx:{minWidth:32,width:32,height:32,padding:0,backgroundColor:ce.data?.primaryColor??"rgba(0, 0, 0, 1)",border:"1px solid rgba(0,0,0,0.2)"}}),e.jsx(G,{sx:{color:"white",fontSize:12},children:"Color línea"}),e.jsx(lt,{open:!!_,anchorEl:_,onClose:()=>U(null),anchorOrigin:{vertical:"bottom",horizontal:"left"},children:e.jsx(v,{sx:{p:1},children:e.jsx(ct,{color:we(ce.data?.primaryColor),onChange:r=>De({primaryColor:ae(r)})})})})]})]}),e.jsx(v,{sx:{display:"flex",justifyContent:"center"},children:e.jsx(J,{variant:"contained",size:"small",fullWidth:!0,startIcon:e.jsx("span",{className:"material-symbols-rounded",children:"swap_horiz"}),onClick:()=>De({invertHandles:!(ce.data?.invertHandles??!1)}),children:"Invertir handles"})})]})]}):null,e.jsxs(dt,{open:zo,onClose:Hr,maxWidth:"sm",children:[e.jsx(ut,{sx:{textAlign:"center",backgroundColor:"#263238",color:"#fff",fontSize:18,fontWeight:400,padding:"12px 16px"},children:"Crear Nuevo Esquema"}),e.jsx(gt,{sx:{mt:2},children:e.jsx(G,{children:"¿Estás seguro de que quieres crear un nuevo esquema? Se perderán todos los cambios no guardados."})}),e.jsxs(ht,{children:[e.jsx(J,{onClick:Hr,children:"Cancelar"}),e.jsx(J,{onClick:Xo,variant:"contained",color:"error",children:"Crear Nuevo"})]})]}),e.jsxs(dt,{open:z,onClose:fe,maxWidth:"xs",children:[e.jsx(ut,{sx:{textAlign:"center",backgroundColor:"#263238",color:"#fff",fontSize:18,fontWeight:400,padding:"12px 16px"},children:"Nombre de usuario requerido"}),e.jsxs(gt,{sx:{mt:2},children:[e.jsx(G,{sx:{mb:1},children:"Introduce un nombre de usuario alfanumérico (mínimo 6 caracteres)."}),e.jsx(de,{autoFocus:!0,margin:"dense",label:"Nombre de usuario",fullWidth:!0,variant:"outlined",value:pe,onChange:r=>W(r.target.value.toLowerCase().trim()),onKeyDown:r=>{r.key==="Enter"&&Ee()},helperText:pe&&!ee(pe)?"Debe ser alfanumérico y al menos 6 caracteres":""})]}),e.jsx(ht,{children:e.jsx(J,{onClick:()=>{Ee()},variant:"contained",children:"Aceptar"})})]}),e.jsxs(dt,{open:Pr,onClose:()=>_t(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ut,{sx:{textAlign:"center",backgroundColor:"#263238",color:"#fff",fontSize:18,fontWeight:400,padding:"12px 16px"},children:"Guardar Esquema"}),e.jsxs(gt,{sx:{mt:2},children:[e.jsx(de,{autoFocus:!0,margin:"dense",label:"Nombre del esquema",fullWidth:!0,variant:"outlined",value:et,onChange:r=>ft(r.target.value),slotProps:{inputLabel:{shrink:!0}}}),e.jsx(de,{margin:"dense",label:"Descripción (opcional)",fullWidth:!0,variant:"outlined",multiline:!0,rows:3,value:tt,onChange:r=>At(r.target.value),slotProps:{inputLabel:{shrink:!0}}}),e.jsx(Kt,{control:e.jsx(Vt,{checked:Ye,onChange:r=>Ft(r.target.checked),disabled:!!(Te||ar)}),label:"No guardar en la nube"})]}),e.jsxs(ht,{children:[e.jsx(J,{onClick:()=>_t(!1),children:"Cancelar"}),e.jsx(J,{onClick:()=>{Lo()},variant:"contained",children:Te?"Actualizar":"Guardar"})]})]}),e.jsxs(dt,{open:We,onClose:()=>Fe(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ut,{sx:{textAlign:"center",backgroundColor:"#263238",color:"#fff",fontSize:18,fontWeight:400,padding:"12px 16px"},children:"Esquemas Guardados"}),e.jsxs(gt,{sx:{mt:2},children:[e.jsxs(v,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsxs(vr,{sx:{minWidth:160},children:[e.jsx(Sr,{id:"schema-filter-label",children:"Mostrar"}),e.jsxs(kr,{labelId:"schema-filter-label",value:Or,label:"Mostrar",onChange:r=>No(r.target.value),children:[e.jsx(Le,{value:"activos",children:"Activos"}),e.jsx(Le,{value:"eliminados",children:"Eliminados"}),e.jsx(Le,{value:"todos",children:"Todos"}),e.jsx(Le,{value:"locales",children:"Locales"}),e.jsx(Le,{value:"propios",children:"Propios"})]})]}),e.jsx(de,{margin:"dense",label:"Buscar por nombre o descripción",fullWidth:!0,variant:"outlined",value:Rr,onChange:r=>Eo(r.target.value),slotProps:{inputLabel:{shrink:!0}}})]}),e.jsx(Dn,{children:(()=>{const r=Rr.trim().toLowerCase(),f=(r?$t.filter(g=>(g.name||"").toLowerCase().includes(r)||(g.description||"").toLowerCase().includes(r)):$t).filter(g=>{switch(Or){case"activos":return g.hidden!==!0;case"eliminados":return g.hidden===!0;case"todos":return!0;case"locales":return g.local===!0;case"propios":return(g.created_by||"")===(X||localStorage.getItem("dp_username")||"");default:return!0}});return f.length===0?e.jsx(eo,{children:e.jsx(to,{primary:r?"No se encontraron resultados":"No hay esquemas guardados"})}):f.map(g=>{const j=!!g.local,C=!!g.synchronized,Y=j?"cloud_off":C?"cloud_done":"cloud_alert",$=j?sr.palette.error.main:C?sr.palette.success.main:sr.palette.warning.main;return e.jsxs(eo,{secondaryAction:e.jsxs(e.Fragment,{children:[e.jsx(Ie,{edge:"end",color:"primary",onClick:()=>{Oo(g)},title:"Cargar esquema (reemplaza actual)",sx:{mr:1},children:e.jsx("span",{className:"material-symbols-rounded",children:"edit"})}),e.jsx(Ie,{edge:"end",color:"primary",onClick:()=>{Wo(g)},title:"Importar elementos al esquema actual",sx:{mr:1},children:e.jsx("span",{className:"material-symbols-rounded",children:"merge_type"})}),e.jsx(Ie,{edge:"end",color:"primary",onClick:()=>{qo(g.id,g.name)},title:"Duplicar esquema",sx:{mr:1},children:e.jsx("span",{className:"material-symbols-rounded",children:"content_copy"})}),g.hidden===!0?e.jsx(Ie,{edge:"end",color:"success",onClick:()=>{Bo(g.id,g.name)},title:"Restaurar esquema",children:e.jsx("span",{className:"material-symbols-rounded",children:"restore_from_trash"})}):e.jsx(Ie,{edge:"end",color:"error",onClick:()=>{Fo(g.id,g.name)},title:"Eliminar esquema",children:e.jsx("span",{className:"material-symbols-rounded",children:"delete"})})]}),children:[e.jsx(v,{sx:{display:"flex",alignItems:"center",mr:1},children:e.jsx("span",{className:"material-symbols-rounded",style:{color:$,fontSize:20},children:Y})}),e.jsx(to,{primary:g.name,secondary:e.jsxs(e.Fragment,{children:[g.description?e.jsx(G,{component:"span",display:"block",children:g.description}):null,e.jsxs(G,{component:"span",sx:{whiteSpace:"pre-line"},children:["Creado: ",new Date(g.created_at||"").toLocaleString()," • Usuario: ",g.created_by??"—"]})]})})]},g.id)})})()})]}),e.jsxs(ht,{children:[e.jsx(J,{onClick:()=>{To()},color:"primary",children:"Sincronizar"}),e.jsx(J,{onClick:()=>Fe(!1),children:"Cerrar"})]})]}),e.jsx(w.Suspense,{fallback:null,children:e.jsx(ms,{open:Be,onClose:()=>Ze(!1),svgName:Rt,setSvgName:Er,svgDescription:tr,setSvgDescription:Ir,svgCategory:Dr,setSvgCategory:zr,categories:So,svgHandles:rr,setSvgHandles:Tr,svgMarkup:Qe,setSvgMarkup:Mr,useEditor:Co,setUseEditor:Lr,sanitizedSvg:jo,svgElements:Ct,onSaveSvgElement:Po})}),$o,e.jsx(ys,{}),e.jsx(v,{sx:{position:"absolute",bottom:8,left:"50%",transform:"translateX(-50%)",zIndex:1200},children:e.jsx(G,{component:"a",href:"https://github.com/pnbarbeito/DrawPaK-Web",target:"_blank",rel:"noopener noreferrer",variant:"caption",sx:{color:"rgba(37, 34, 34, 0.85)",textDecoration:"none"},children:"Publicado bajo licencia Apache-2.0 - © 2025 Pablo N. Barbeito"})})]})}function xs(){return e.jsx(ws,{})}const bs=zn({palette:{mode:"light",background:{default:"#f5f7fb",paper:"#ffffff"}},components:{MuiAppBar:{styleOverrides:{root:{background:"#263238"}}}}});Mn.createRoot(document.getElementById("root")).render(e.jsx(N.StrictMode,{children:e.jsxs(Tn,{theme:bs,children:[e.jsx(Ln,{}),e.jsx(xs,{})]})}));
